# Verification: P5-01 — Tenant-safe file storage and download gating

## Objective
Ensure every uploaded file is stored and served within a clinic-specific namespace, with strict access control gating.

## 1. Storage Isolation Proof
**Location:** `writable/uploads/`
**Structure:**
```
writable/uploads/
├── clinic_1/
│   └── 1705254123_random.png
└── clinic_2/
    └── 1705254124_random.jpg
```
**Mechanism:** `StorageService::store()` automatically creates the `clinic_{id}` directory and moves valid uploads there.

## 2. Gated Download Verification
**Route:** `GET /file/download/{id}`
**Controller:** `FileController::download($id)`
**Logic:**
1. Verifies `active_clinic_id` exists in session.
2. Queries `file_attachments` using `where('clinic_id', $clinicId)` (TenantTrait protection).
3. If the file belongs to another clinic, returns 404 (Fail-Closed).
4. If valid, streams the file from the private `writable` directory.

## 3. Integration Proof (Logo Upload)
- Uploaded a logo for Clinic A.
- Database `settings` table for Clinic A now has `clinic_logo_path` = `file/download/1`.
- The logo is served via the secure route.
- Attempting to access `file/download/1` while logged into Clinic B results in a 404.

## 4. Guardrail Compliance
**Command:** `bash scripts/ci/saas_guardrails.sh`
**Result:** Passed with baseline counts. No raw `table()` calls added.
**New Allowlist Entry:** None required.

## Settings constraint fix (per-clinic metadata)

- `php spark migrate:status`  
  Confirms `2026-01-15-000000 AdjustSettingsUniqueIndex` is now migrated (Migrated On: 2026-01-14 18:07:04, Batch 7).

- `SHOW INDEX FROM settings`  
  Only `clinic_setting_key` remains as a UNIQUE index on `(clinic_id, setting_key)`; the global `setting_key` index was dropped.

- `SELECT clinic_id, setting_key, setting_value FROM settings WHERE setting_key='clinic_name' ORDER BY clinic_id;`  
  Returns two rows, demonstrating Clinic A and Clinic B now store separate `clinic_name` values.

- Guardrail verification: `bash scripts/ci/saas_guardrails.sh` (DOM=0, Group=0, Raw=24) – no regressions.
