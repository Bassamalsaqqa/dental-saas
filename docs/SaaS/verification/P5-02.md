# P5-02: IDOR Sweep on Tenant Resources

**Status:** Stage B (Remediation Complete)
**Date:** 2026-01-14

## Policy
- **HTML Endpoints:** Return `404 Not Found` on tenant mismatch.
- **API/AJAX Endpoints:** Return `403 Forbidden` with JSON `{"error": "TENANT_VIOLATION"}` or similar.
- **Strict Requirement:** Every fetch by ID must be scoped: `where('id', $id)->where('clinic_id', $activeClinicId)` or equivalent.

## Audit Matrix

| Route | HTTP Method | Controller::Method | Resource | Risk | Denial Policy | Current Enforcement | Notes | File:Line |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| `patient/([0-9]+)` | GET | `Patient::show` | Patient | High | HTML 404 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Patient.php` |
| `patient/([0-9]+)/edit` | GET | `Patient::edit` | Patient | High | HTML 404 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Patient.php` |
| `patient/([0-9]+)/update` | POST | `Patient::update` | Patient | High | HTML 404 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Patient.php` |
| `patient/delete/([0-9]+)` | DELETE | `Patient::delete` | Patient | High | API 403 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Patient.php` |
| `patient/([0-9]+)/data` | GET | `Patient::getPatientData` | Patient | Med | API 403 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Patient.php` |
| `examination/([0-9]+)` | GET | `Examination::show` | Exam | High | HTML 404 | **PASS** | Scoped query | `app/Controllers/Examination.php` |
| `examination/([0-9]+)/edit` | GET | `Examination::edit` | Exam | High | HTML 404 | **PASS** | Scoped query | `app/Controllers/Examination.php` |
| `examination/([0-9]+)/print` | GET | `Examination::print` | Exam | Med | HTML 404 | **PASS** | Scoped query | `app/Controllers/Examination.php` |
| `appointment/([0-9]+)` | GET | `Appointment::show` | Appt | High | HTML 404 | **PASS (Fixed)** | Updated Model to accept clinicId | `app/Controllers/Appointment.php` |
| `appointment/([0-9]+)/edit` | GET | `Appointment::edit` | Appt | High | HTML 404 | **PASS (Fixed)** | Explicit `clinic_id` check | `app/Controllers/Appointment.php` |
| `appointment/([0-9]+)/update` | POST | `Appointment::update` | Appt | High | HTML 404 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Appointment.php` |
| `appointment/([0-9]+)/print` | GET | `Appointment::print` | Appt | Med | HTML 404 | **PASS (Fixed)** | Updated Model to accept clinicId | `app/Controllers/Appointment.php` |
| `finance/([0-9]+)` | GET | `Finance::show` | Finance | High | HTML 404 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Finance.php` |
| `finance/([0-9]+)/edit` | GET | `Finance::edit` | Finance | High | HTML 404 | **PASS (Fixed)** | Explicit `clinic_id` check | `app/Controllers/Finance.php` |
| `finance/([0-9]+)/invoice` | GET | `Finance::generateInvoice` | Finance | High | HTML 404 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Finance.php` |
| `treatment/([0-9]+)` | GET | `Treatment::show` | Treatment | High | HTML 404 | **PASS** | `getTreatmentWithPatientInfoByClinic` | `app/Controllers/Treatment.php` |
| `treatment/([0-9]+)/update` | POST | `Treatment::update` | Treatment | High | HTML 404 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Treatment.php` |
| `treatment/get-treatments` | POST | `Treatment::getTreatmentsData` | Treatment | High | API 403 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Treatment.php` |
| `prescription/get-prescriptions` | POST | `Prescription::getPrescriptionsData` | RX | High | API 403 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Prescription.php` |
| `inventory/*` | ALL | `Inventory::*` | Item | High | Mixed | **PASS (Fixed)** | All methods scoped | `app/Controllers/Inventory.php` |
| `odontogram/([0-9]+)` | GET | `Odontogram::index` | Patient | High | HTML 404 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Odontogram.php` |
| `api/v1/patients/*` | ALL | `Api\Patient::*` | Patient | High | API 403 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Api/Patient.php` |
| `api/v1/examinations/*` | ALL | `Api\Examination::*` | Exam | High | API 403 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Api/Examination.php` |
| `api/v1/appointments/*` | ALL | `Api\Appointment::*` | Appt | High | API 403 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Api/Appointment.php` |
| `api/v1/finances/*` | ALL | `Api\Finance::*` | Finance | High | API 403 | **PASS (Fixed)** | Added `where('clinic_id', $cid)` | `app/Controllers/Api/Finance.php` |
| `file/download/([0-9]+)` | GET | `FileController::download` | File | High | API 403 | **PASS** | Scoped query | `app/Controllers/FileController.php` |

## Verification Evidence
All listed endpoints have been patched to include `where('clinic_id', session('active_clinic_id'))` before executing `find()` or `update()` or `delete()`.
API endpoints now return `403 Forbidden` if the clinic context is missing or if the resource does not belong to the active clinic.
HTML endpoints redirect or throw `PageNotFoundException` (404) to prevent existence leakage.

## Stage C: Guardrail Remediation (Raw SQL Removal)
**Date:** 2026-01-14
**Status:** Completed

### Actions
- Refactored `Inventory`, `Doctor`, `Users`, `Treatment`, `Prescription`, and `Settings` controllers.
- Removed all usages of `$db->table()` targeting tenant tables.
- Moved logic to tenant-aware Models (`InventoryModel`, `TreatmentModel`, `PrescriptionModel`, `UserModel`) or Services (`SettingsService`).
- Created `ClinicUserModel` to handle `clinic_users` table inserts safely.
- Updated `docs/SaaS/guardrails/raw-tenant-queries.allowlist` to remove fixed entries.

### Verification
`rg "db->table" app/Controllers/Doctor.php app/Controllers/Users.php app/Controllers/Inventory.php app/Controllers/Prescription.php app/Controllers/Treatment.php app/Controllers/Settings.php`
Result: (empty)

`rg "db->query" app/Controllers/Settings.php`
Result: (empty)

## Guardrail Run
- Command: `bash scripts/ci/saas_guardrails.sh`
- Output:
  ```
  Guardrail 'DOM sinks in app/Views' passed (0 match(es)).
  Guardrail 'Group-based auth helpers' passed (0 match(es)).
  Guardrail 'Raw tenant queries in controllers' passed (8 match(es)).
  SaaS guardrail validation succeeded.
  ```
