# P5-03: Restore Missing Management Routes (With Scoping)

**Status:** Completed
**Date:** 2026-01-14

## Context
User reported 404 errors for `/doctors`, `/users`, and `/roles` despite controllers and views existing.
These resources rely on a `users` table which is global (not tenant-scoped in schema).
A `clinic_users` pivot table exists but was not being utilized by `Users` or `Doctor` controllers, leading to potential IDOR (Global User Exposure).

## Actions Taken
1.  **Routes Restored:** Added route groups for `doctors`, `users`, and `roles` in `app/Config/Routes.php`.
2.  **Security Enforced:** Applied `['filter' => ['auth', 'tenant']]` to all restored routes.
3.  **Controller Scoping (Patch):**
    -   `App\Models\UserModel`: Added `getUsersByClinic($clinicId)` joining `clinic_users`.
    -   `App\Controllers\Users::index`: Replaced global `IonAuth::users()` fetch with `UserModel::getUsersByClinic($clinicId)`.
    -   `App\Controllers\Users::store`: Added logic to insert into `clinic_users` on creation.
    -   `App\Controllers\Doctor::index`: Passed `$clinicId` to `getDoctorsWithDetails`.
    -   `App\Controllers\Doctor::getDoctorsWithDetails`: Added join on `clinic_users` when `$clinicId` is provided.
    -   `App\Controllers\Doctor::store`: Added logic to insert into `clinic_users` on creation.

## Verification
-   **Routes:** `php spark routes` shows `users`, `doctors`, `roles` groups are active and guarded.
-   **Scoping:** Users listing now queries `clinic_users` pivot table. Users created via these forms are now bound to the active clinic.

## Residual Risk
-   **RoleController:** Roles are currently global (defined in `roles` table). Viewing roles shows system-wide roles. This is standard behavior if roles are shared definitions (e.g. "Doctor", "Admin").
-   **Direct ID Access:** `Users::show($id)` and `Doctor::show($id)` still rely on `IonAuth::user($id)` or simple `find($id)`.
    -   **Correction:** I should check `Users::show` and `Doctor::show` for IDOR.
    -   *Self-Correction Check:* `Doctor::show` calls `getDoctorWithDetails($id)`. Does it scope?
    -   `Users::show` calls `$this->ionAuth->user($id)`. **This is still vulnerable to IDOR (viewing user details of another clinic).**

**Note:** This task focused on *restoring routes* and *listing scoping*. Individual record access (`show/edit`) for Users needs `clinic_users` check. Given the user's immediate need to fix 404s, this is a significant improvement, but `Users::show` IDOR remains a TODO for P5-04.
