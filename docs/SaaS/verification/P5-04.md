# P5-04: Management IDOR Closure (Users/Doctor)

**Status:** Completed
**Date:** 2026-01-14

## Context
Endpoints handling sensitive user and doctor management (`/users`, `/doctors`) accepted IDs without validating that the target resource belonged to the active tenant (clinic). This vulnerability allowed a clinic admin to potentially access or modify users from other clinics.

## Actions Taken
1.  **Model Enhancements:**
    *   `ClinicUserModel`: Added `isUserInClinic($clinicId, $userId)` to quickly verify membership.
    *   `UserModel`: Added `findByClinic($clinicId, $userId)` to fetch users strictly scoped to a clinic via the `clinic_users` pivot table.
    *   `UserModel`: Updated `getDoctorWithDetails($id, $clinicId)` to support optional clinic scoping.

2.  **Controller Hardening (Users):**
    *   Updated `show`, `edit`, `update`, `delete`, `changePassword`, `updatePassword`, `toggleStatus` to:
        *   Require `active_clinic_id` session.
        *   Use `findByClinic` or `isUserInClinic` to validate ownership.
        *   Return 404 (PageNotFound) or 403 (JSON) on failure.
    *   Updated RBAC AJAX methods (`assignRole`, `removeRole`, `grantPermission`, `revokePermission`, `getUserPermissionsAjax`) to enforce `isUserInClinic` check.

3.  **Controller Hardening (Doctor):**
    *   Updated `show`, `edit`, `update`, `delete` to:
        *   Require `active_clinic_id` session.
        *   Use `getDoctorWithDetails($id, $clinicId)` to enforce scope.
        *   Return 404 or 403 on failure.

## Verification Matrix

| Controller | Method | Action | Risk | Protection Implemented |
| :--- | :--- | :--- | :--- | :--- |
| **Users** | `show` | View User | High | `findByClinic` (404) |
| **Users** | `edit` | Edit Form | High | `findByClinic` (404) |
| **Users** | `update` | Save Update | High | `findByClinic` (404) |
| **Users** | `delete` | Delete User | High | `findByClinic` (403/JSON) |
| **Users** | `changePassword` | Form | High | `findByClinic` (404) |
| **Users** | `updatePassword` | Action | High | `findByClinic` (404) |
| **Users** | `toggleStatus` | Action | High | `findByClinic` (403/JSON) |
| **Users** | `assignRole` | AJAX | High | `isUserInClinic` (403/JSON) |
| **Users** | `removeRole` | AJAX | High | `isUserInClinic` (403/JSON) |
| **Doctor** | `show` | View Doctor | High | `getDoctorWithDetails($id, $cid)` (404) |
| **Doctor** | `edit` | Edit Form | High | `getDoctorWithDetails($id, $cid)` (404) |
| **Doctor** | `update` | Save Update | High | `getDoctorWithDetails($id, $cid)` (404) |
| **Doctor** | `delete` | Action | High | `getDoctorWithDetails($id, $cid)` (403/JSON) |

## Post-Verification Fixes
- **Syntax Error Fix:** Resolved a `ParseError` in `ClinicUserModel.php` (missing closing brace).
- **Users RBAC Hardening:** Applied tenant isolation checks to `assignRole`, `removeRole`, `grantPermission`, `revokePermission`, and `getUserPermissionsAjax` which were initially missed in the first pass.
- **Doctor Update/Delete:** Confirmed and fixed unsafe `find($id)` calls in `Doctor::update` and `Doctor::delete` to use tenant-scoped lookups.