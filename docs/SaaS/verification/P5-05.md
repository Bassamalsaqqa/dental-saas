# P5-05: Tenant-safe exports/PDFs/reports (Persist exports policy)

**Status:** Completed
**Date:** 2026-01-15

## Context
Standard "stream-only" exports lacked persistence, making it difficult to audit what was actually sent to users and increasing the risk of transient data exposure. The new policy requires every export/print/PDF action to be persisted as a `file_attachment` within the tenant's isolated storage namespace before delivery.

## Actions Taken
1.  **Infrastructure:**
    -   Modified `file_attachments` table via migration to add `purpose` and `file_hash`.
    -   Enhanced `StorageService` with `storeExport()` method to handle content persistence, hash-based naming, and automatic superseding of previous artifacts (idempotency).
2.  **Controller Hardening:**
    -   Updated the following controllers to enforce ownership BEFORE generation and to persist artifacts:
        -   `Finance`: `generateInvoice` (PDF/HTML), `export` (CSV).
        -   `Examination`: `print` (HTML/PDF).
        -   `Prescription`: `print` (HTML/PDF).
        -   `Odontogram`: `export`, `print`, `pdf`, `downloadPdf`.
        -   `Appointment`: `print` (HTML/PDF).
        -   `Inventory`: `usagePrint` (HTML/PDF).
        -   `Reports`: `export` (PDF, Excel, CSV).
3.  **Security Integration:**
    -   Ownership validation using scoped model methods (e.g., `where('clinic_id', $cid)->find($id)`) is performed at the very beginning of each method.
    -   Download links now point to the secure `/file/download/{attachmentId}` gateway which enforces tenant checks.

## Verification Matrix

| Controller | Endpoint | Type | Ownership | Persistence | PASS/FAIL |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Finance** | `/finance/{id}/invoice` | HTML/PDF | Scoped | `invoice_print` | PASS |
| **Finance** | `/finance/export` | CSV | Scoped | `finance_export` | PASS |
| **Examination** | `/examination/{id}/print` | HTML/PDF | Scoped | `exam_print` | PASS |
| **Prescription** | `/prescription/{id}/print` | HTML/PDF | Scoped | `prescription_print` | PASS |
| **Odontogram** | `/odontogram/{id}/download-pdf` | PDF | Scoped | `odontogram_pdf_download` | PASS |
| **Odontogram** | `/odontogram/{id}/export` | HTML | Scoped | `odontogram_export` | PASS |
| **Appointment** | `/appointment/{id}/print` | HTML/PDF | Scoped | `appointment_print` | PASS |
| **Inventory** | `/inventory/usage-print/{id}` | HTML | Scoped | `usage_print` | PASS |
| **Reports** | `/reports/export` | CSV/PDF/XLS | Scoped | `report_*` | PASS |

## Cross-Tenant Tampering Evidence
- **Scenario:** Clinic B attempts to access Clinic A's invoice.
- **Action:** `GET /finance/123/invoice` where 123 belongs to Clinic A.
- **Result:** `404 Page Not Found` (Fail-closed before generation).
- **Action:** `GET /file/download/{attachmentId}` where attachment belongs to Clinic A.
- **Result:** `403 Forbidden` (Enforced by `FileController`).

## Database Proof
```sql
SELECT clinic_id, entity_type, purpose, file_name FROM file_attachments WHERE purpose LIKE '%export%' OR purpose LIKE '%print%';
```
Verified that records are correctly tagged with `clinic_id` and specific `purpose`.

## Guardrails Check
- No `$db->table()` introduced in controllers.
- Baseline Raw Count: 8.
- Current Raw Count: 8.
