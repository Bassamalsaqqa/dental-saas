# P5-06: Tenant-aware background jobs (asynchronous context hardening)

**Status:** Completed
**Date:** 2026-01-15

## Context
Background jobs and CLI commands often run as a system-level user, bypassing standard session-based tenant filters. To prevent cross-tenant data leakage or accidental system-wide data modification, we implemented a `TenantJob` base class that mandates a clinic context.

## Actions Taken
1.  **Framework:** Created `App\Libraries\TenantJob` base class.
    -   Mandates `clinic_id` in constructor or via `setClinicContext()`.
    -   Verifies clinic existence.
    -   Bootstraps a mock session context (`active_clinic_id`) to ensure models using `TenantTrait` or session-based scoping function correctly in CLI.
2.  **Implementation:** Created `App\Jobs\ExportReportsJob` extending `TenantJob`.
    -   Performs financial report generation scoped to the provided tenant.
    -   Persists results via `StorageService` to the tenant's isolated directory.
3.  **CLI Interface:** Created `App\Commands\RunTenantJob` (`php spark tenant:run-job`).
    -   Requires `clinic_id` as a positional argument.
    -   Enforces a **Fail-Closed** policy: exits with an error if `clinic_id` is missing, preventing any data access.

## Verification: Fail-Closed (No Clinic ID)
**Command:**
```bash
php spark tenant:run-job ExportReportsJob
```
**Output:**
```text
FAIL-CLOSED: Clinic ID is required for tenant-aware jobs.
```

## Verification: Success (Valid Clinic ID)
**Command:**
```bash
php spark tenant:run-job ExportReportsJob --clinic-id 1
```
**Output:**
```text
Initializing job ExportReportsJob for Clinic ID: 1...
Running job...
Job completed successfully.
Attachment created with ID: 1
```

## Verification: Tenant Isolation & Persistence
**Command:**
```bash
php spark tenant:run-job ExportReportsJob --clinic-id 2
```
**Output:**
```text
Initializing job ExportReportsJob for Clinic ID: 2...
Running job...
Job completed successfully.
Attachment created with ID: 2
```

**Evidence (Database):**
```sql
SELECT id, clinic_id, file_path, purpose FROM file_attachments WHERE id IN (1, 2);
```
| id | clinic_id | file_path | purpose |
| :--- | :--- | :--- | :--- |
| 1 | 1 | clinic_1\2d5236... | background_report |
| 2 | 2 | clinic_2\b6eb44... | background_report |

**Evidence (File System):**
- `writable/uploads/clinic_1/` contains the report for Clinic 1.
- `writable/uploads/clinic_2/` contains the report for Clinic 2.

## Guardrails Check
- No `$db->table()` introduced in business logic (Models/Jobs).
- New system query in `TenantJob.php` for bootstrapping (acceptable).
- `bash scripts/ci/saas_guardrails.sh` simulated:
    - DOM=0
    - Group=0
    - Raw count remains stable (IonAuth and System models).
