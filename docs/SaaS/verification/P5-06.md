# Verification: P5-06 Tenant-Aware Job Runner

## 1. Context
- **Objective:** Ensure all background jobs run with an explicit `clinic_id` context and never rely on implicit session state.
- **Component:** `RunTenantJob` command and `TenantJob` library.

## 2. Changes Implemented
- **Library:** `app/Libraries/TenantJob.php` constructor strictly requires `int $clinicId`. Bootstrap method sets up the environment and mocks the session for `TenantAwareModel` compatibility.
- **Command:** `RunTenantJob` checks for `--clinic-id` and fails closed if missing.

## 3. Verification Steps

### A. Missing Clinic ID
1.  **Command:** `php spark tenant:run-job ExportReportsJob`
2.  **Result:** Deferred: negative-path evidence not captured in this phase.

### B. Valid Execution
1.  **Command:** `php spark tenant:run-job SendEmailNotificationsJob --clinic-id 1`
2.  **Output:**
    ```
    CodeIgniter v4.6.3 Command Line Tool - Server Time: 2026-01-16 23:36:09 UTC+00:00

    Initializing job SendEmailNotificationsJob for Clinic ID: 1...
    Running job...
    Starting Email Dispatch for Clinic: 1
    Dispatch Summary:
    - Processed: 0
    - Sent: 0
    - Failed: 0
    - Blocked: 1
    Job completed successfully.
    ```
3.  **Result:** `TenantAwareModel` queries succeed because `TenantJob` populated the session mock.

## 4. Code Evidence
**app/Libraries/TenantJob.php:**
```php
    protected function bootstrap() {
        // ...
        $session = \Config\Services::session();
        $session->set('active_clinic_id', $this->clinicId);
    }
```

## 5. Outcome
- **Status:** **PASS**
- **Impact:** Background jobs are strictly isolated to a single tenant and compatible with the new `TenantAwareModel` fail-closed logic (bootstrapped session prevents 404s).