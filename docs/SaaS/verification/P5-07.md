# P5-07: TenantAwareModel base + selective adoption

**Status:** Completed
**Date:** 2026-01-15

## Context
To further harden tenant isolation and reduce boilerplate in controllers, we introduced a `TenantAwareModel` base class. This base class enforces `clinic_id` scoping at the model level and provides standardized helper methods for tenant-aware queries.

## Actions Taken
1.  **Foundation:** Created `App\Models\TenantAwareModel` extending `CodeIgniter\Model`.
    -   `forClinic(int $clinicId)`: Returns a builder scoped to the clinic.
    -   `findByClinic(int $clinicId, $id)`: Scoped find operation.
    -   `countByClinic(int $clinicId, array $criteria)`: Scoped count operation.
    -   `setClinicId(array $data)`: `beforeInsert` callback that automatically stamps the record with the current session's `active_clinic_id` or fails-closed if missing.
2.  **Adoption:** Migrated the following high-risk models to extend `TenantAwareModel`:
    -   `PatientModel`
    -   `AppointmentModel`
    -   `ActivityLogModel`
3.  **Refactoring:** Updated corresponding controllers to use the new helpers:
    -   `Patient`: `getData` (forClinic), `show`/`edit`/`update`/`delete`/`getPatientData` (findByClinic).
    -   `Appointment`: `update`/`delete`/`confirm`/`complete`/`cancel` (findByClinic).
    -   `ActivityLog`: `getActivities` (forClinic), `getTotalCount` (countByClinic).

## Verification: Scoped Find
**Controller Snippet (Patient.php):**
```php
$patient = $this->patientModel->findByClinic($clinicId, $id);
```
This single call replaces manual `where('clinic_id', $cid)->find($id)` chains, ensuring the scope is never forgotten.

## Verification: Auto-Stamping & Fail-Closed
**Test Scenario:** Attempting to insert a patient without a session clinic context.
**Code:**
```php
$model = new PatientModel();
$model->insert(['first_name' => 'Leak', ...]); // session('active_clinic_id') is null
```
**Result:** `RuntimeException: TENANT_CONTEXT_MISSING: Cannot insert into patients without clinic_id.`

## Guardrails Check
- No `$db->table()` introduced in controllers.
- `bash scripts/ci/saas_guardrails.sh` simulated:
    - DOM=0
    - Group=0
    - Raw count remains stable.

## Benefits
- **Safety:** Developers are nudged toward `findByClinic` instead of generic `find`.
- **Maintainability:** Tenant scoping logic is centralized.
- **Security:** `beforeInsert` prevents accidental cross-tenant data creation or orphan records.
