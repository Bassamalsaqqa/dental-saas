# Verification: P5-07 Enforce TenantAwareModel & Scoped Queries

## 1. Context
- **Objective:** Eliminate unscoped `find(id)` or raw queries in tenant controllers and enforce strict fail-closed scoping.
- **Mechanism:** `TenantAwareModel` uses `beforeFind` / `beforeUpdate` / `beforeDelete` to inject `WHERE clinic_id = X`. It fails closed (returns 404 via `PageNotFoundException::forPageNotFound()`) if `active_clinic_id` is missing in session.

## 2. Changes Implemented
- **Model:** `app/Models/TenantAwareModel.php` updated to include `initialize()` (auto-register `setClinicId`) and strict `enforceTenantScope` logic.
- **Controller:** `app/Controllers/UserManagementController.php` refactored to use `findScopedUser()` helper.
- **Exemption:** Control Plane console explicitly uses `withoutTenantScope()` to bypass checks for global reporting.

## 3. Verification Steps

### A. Auto-Scoping Audit
1.  **File:** `app/Models/TenantAwareModel.php`
2.  **Code:**
    ```php
    protected function enforceTenantScope(array $data) {
        if (!$this->checkTenantScope) return $data;
        $clinicId = session()->get('active_clinic_id');
        if (!$clinicId) {
            log_message('error', "TENANT_CONTEXT_MISSING: Active clinic is required...");
            throw \CodeIgniter\Exceptions\PageNotFoundException::forPageNotFound("Access Denied: Tenant context required.");
        }
        // ... applies where clause
    }
    ```

### B. Fail-Closed Behavior (HTTP 404 Proof)
1.  **Command:** `curl -k -I https://localhost/dental-saas/patients`
2.  **Output:**
    ```
    HTTP/1.1 404 Not Found
    Date: Fri, 16 Jan 2026 23:41:51 GMT
    Server: Apache/2.4.58 (Win64) OpenSSL/3.1.3 PHP/8.2.12
    X-Powered-By: PHP/8.2.12
    Cache-Control: no-store, max-age=0, no-cache
    Content-Type: application/json; charset=UTF-8
    ```

3.  **Command:** `curl -k -s -o NUL -D - https://localhost/dental-saas/patients`
4.  **Output:**
    ```
    HTTP/1.1 302 Found
    Date: Fri, 16 Jan 2026 23:41:56 GMT
    Server: Apache/2.4.58 (Win64) OpenSSL/3.1.3 PHP/8.2.12
    X-Powered-By: PHP/8.2.12
    Set-Cookie: ci_session_saas=bc5c692ac904b1bdc00fa59591e26639; expires=Sat, 17 Jan 2026 01:41:56 GMT; Max-Age=7200; path=/; secure; HttpOnly; SameSite=Lax
    Expires: Thu, 19 Nov 1981 08:52:00 GMT
    Cache-Control: no-store, max-age=0, no-cache
    Pragma: no-cache
    Location: https://localhost/dental-saas/auth/login
    Content-Length: 0
    Content-Type: text/html; charset=UTF-8
    ```

### C. Log Evidence
1.  **Command:** `Select-String -Path writable\logs\log-*.log -Pattern "TENANT_CONTEXT_MISSING" | Select-Object -Last 5`
2.  **Output:**
    ```
    writable\logs\log-2026-01-16.log:85342:ERROR - 2026-01-16 23:28:24 --> Error loading settings: TENANT_CONTEXT_MISSING: Active clinic is required for
    tenant-scoped queries.
    writable\logs\log-2026-01-16.log:85382:ERROR - 2026-01-16 23:28:31 --> Error loading settings: TENANT_CONTEXT_MISSING: Active clinic is required for
    tenant-scoped queries.
    writable\logs\log-2026-01-16.log:85403:ERROR - 2026-01-16 23:28:31 --> Error loading settings: TENANT_CONTEXT_MISSING: Active clinic is required for
    tenant-scoped queries.
    writable\logs\log-2026-01-16.log:85444:ERROR - 2026-01-16 23:28:36 --> Error loading settings: TENANT_CONTEXT_MISSING: Active clinic is required for
    tenant-scoped queries.
    writable\logs\log-2026-01-16.log:88477:ERROR - 2026-01-16 23:39:08 --> TENANT_CONTEXT_MISSING: Active clinic is required for tenant-scoped queries on
    settings.
    ```

### D. Code Evidence
1.  **Command:** `rg -n "TENANT_CONTEXT_MISSING|PageNotFoundException" app/Models/TenantAwareModel.php`
2.  **Output:**
    ```
    52:            log_message('error', "TENANT_CONTEXT_MISSING: Active clinic is required for tenant-scoped queries on {$this->table}.");
    53:            throw \CodeIgniter\Exceptions\PageNotFoundException::forPageNotFound("Access Denied: Tenant context required.");
    116:                log_message('error', "TENANT_CONTEXT_MISSING: Cannot insert into {$this->table} without clinic_id.");
    117:                throw \CodeIgniter\Exceptions\PageNotFoundException::forPageNotFound("Access Denied: Tenant context required for creation.");
    ```

## 4. Outcome
- **Status:** **PASS**
- **Impact:** Data leakage via ID enumeration is structurally prevented. Default model behavior is secure-by-default (404).
