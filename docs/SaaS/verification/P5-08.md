# P5-08 Verification Report: Export Retention Policy

## 1. Summary
This document verifies the implementation of the platform-wide Export Retention Policy. The policy ensures that export artifacts (PDFs, CSVs, etc.) are managed according to Superadmin-configured rules, preventing storage bloat while maintaining necessary history.

## 2. Configuration Evidence

### 2.1 Retention Settings
**Location:** Settings -> Export Retention (Visible only in Global Mode / Superadmin)

**Database Proof (Global Settings):**
```sql
SELECT setting_key, setting_value FROM settings WHERE clinic_id = 0 AND setting_key LIKE 'retention_%';
```
| setting_key | setting_value |
| :--- | :--- |
| retention_mode | keep_last_n |
| retention_last_n | 2 |
| retention_days | 30 |

## 3. Policy Enforcement Tests

### 3.1 "latest" Mode Test
1. Set `retention_mode` to `latest`.
2. Generate Export A for Patient 1. (FileAttachment ID: 10, Status: Active)
3. Generate Export B for Patient 1 (same purpose). (FileAttachment ID: 11, Status: Active)
4. **Result:** ID 10 is soft-deleted. Only ID 11 remains active.

### 3.2 "keep_last_n" Mode Test (N=2)
1. Set `retention_mode` to `keep_last_n` and `retention_last_n` to 2.
2. Generate Exports A, B, and C for the same entity/purpose.
3. **Result:**
   - Export C (Newest) -> Active
   - Export B -> Active
   - Export A (Oldest) -> Soft-deleted
4. Verified that only the newest 2 records are active in `file_attachments`.

### 3.3 "keep_x_days" Mode Test
1. Set `retention_mode` to `keep_x_days` and `retention_days` to 1.
2. Manually backdate a `file_attachment` record's `created_at` to 2 days ago.
3. Generate a new export for the same entity.
4. **Result:** The backdated record is soft-deleted.

## 4. Physical Pruning Evidence

### 4.1 CLI Pruning
**Command:**
```bash
php spark exports:prune
```
**Output:**
```text
Starting physical pruning of export files...
SUCCESS: 3 files were permanently removed from disk.
```

### 4.2 Disk Verification
Before Pruning:
- `writable/uploads/clinic_1/` contains files for both active and soft-deleted attachments.

After Pruning:
- Files corresponding to soft-deleted attachments are removed.
- Active attachment files remain intact.

## 5. Guardrails Check
**Command:** `bash scripts/ci/saas_guardrails.sh`
**Result:** Passed.
- No direct table access in controllers.
- No `innerHTML` regressions.
- Raw query count remains within baseline (8).