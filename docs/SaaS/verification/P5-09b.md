# P5-09b Verification Report: SMTP Email Delivery (Clinic-Scoped)

## 1. Summary
This document verifies the implementation of the clinic-scoped SMTP email delivery system. The system builds on the Notification Governance layer (P5-09a) to safely dispatch pending emails using per-clinic configurations.

## 2. Components
- **Service:** `NotificationService::dispatchPendingEmails(int $clinicId)`
  - Loads encrypted SMTP config for the clinic.
  - Fetches `pending` emails for the clinic.
  - Resolves recipient emails (User/Patient).
  - Sends via CodeIgniter Email library (SMTP).
  - Updates ledger (`sent` or `failed` with reason).
- **Job:** `App\Jobs\SendEmailNotificationsJob` (Extends `TenantJob`)
  - CLI entry point for dispatching emails.
  - Enforces tenant context bootstrapping.

## 3. Verification Tests (CLI Simulation)
**Command:**
```bash
php spark tenant:run-job SendEmailNotificationsJob --clinic-id <CLINIC_ID>
```

The CLI run confirmed the following scenarios:

| Test Case | Condition | Expected Result | Actual Result |
| :--- | :--- | :--- | :--- |
| **1. Missing Email** | Patient with `email=NULL` | Ledger `status=blocked`, `reason=PATIENT_EMAIL_MISSING` | **PASS** |
| **2. SMTP Failure** | Valid recipient, Bad SMTP Creds | Ledger `status=failed`, `reason=SMTP_SEND_FAILED...` | **PASS** |
| **3. Config Check** | Channel disabled/unvalidated | Pending rows marked failed (`CHANNEL_NOT_READY_AT_DISPATCH`) | **Verified in Service Logic** |

## 4. Safety & Governance
- **Tenant Isolation:** Dispatcher requires `clinicId` and only loads notifications matching that ID.
- **Recipient Enforcement:**
  - Users: Verified via `ClinicUserModel::isUserInClinic`.
  - Patients: Verified via `PatientModel::findByClinic`.
- **Ledger Integrity:** All attempts (successful, blocked, failed) are recorded; no rows are deleted.

## 5. Guardrails Check
**Command:** `bash scripts/ci/saas_guardrails.sh`
**Result:** Passed.
- DOM Sinks: 0
- Auth Bypasses: 0
- Raw Tenant Queries: 8 (Baseline preserved)
