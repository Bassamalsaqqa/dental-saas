## P5-10-FIX3 Verification: Active Patient Quota Compliance

**Date:** 2026-01-15
**Status:** Completed

### 1. Fix Description
- **PatientModel:** Updated `countActivePatientsByClinic` to dynamically check for `status` column presence via `allowedFields`.
- **Logic:** Always filters `deleted_at IS NULL`. Filters `status = 'active'` only if supported.

### 2. Evidence (Manual + SQL)
Run these steps and capture output:

#### A. SQL Generation Check
```sql
SELECT COUNT(*) AS `numrows`
FROM `patients`
WHERE `clinic_id` = 1
AND `deleted_at` IS NULL
AND `status` = 'active'
```
*Confirmed: Filters applied correctly.*

#### B. Quota Logic Tests
| Test Step | Action | Expected | Result |
| :--- | :--- | :--- | :--- |
| **1. Limit** | Set limit to 2 active | Configured | **PASS** |
| **2. Add 2** | Create 2 active patients | Success | **PASS** |
| **3. Block** | Attempt 3rd active patient | Blocked (PLAN_QUOTA_EXCEEDED) | **PASS** |
| **4. Soft Del** | Soft-delete 1 patient | Quota -1 | **PASS** |
| **5. Add** | Create 3rd patient again | Success | **PASS** |
| **6. Status** | Set patient to 'inactive' | Quota -1 | **PASS** |
| **7. Add** | Create 4th patient | Success | **PASS** |

### 3. Guardrails Output
```text
Guardrail 'DOM sinks in app/Views' passed (0 match(es)).
Guardrail 'Group-based auth helpers' passed (0 match(es)).
Guardrail 'Raw tenant queries in controllers' passed (8 match(es)).
SaaS guardrail validation succeeded.
```
