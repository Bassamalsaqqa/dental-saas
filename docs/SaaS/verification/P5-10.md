## P5-10-FIX3 Verification: Active Patient Quota Compliance

**Date:** 2026-01-15
**Status:** Completed

### 1. Fix Description
- **PatientModel:** Updated `countActivePatientsByClinic` to dynamically check for `status` column presence via `allowedFields`.
- **Logic:** Always filters `deleted_at IS NULL`. Filters `status = 'active'` only if supported.

### 2. Evidence (Manual + SQL)
Run these steps and capture output:

#### A. SQL Generation Check
```sql
SELECT COUNT(*) AS `numrows`
FROM `patients`
WHERE `clinic_id` = 1
AND `deleted_at` IS NULL
AND `status` = 'active'
```
*Confirmed: Filters applied correctly.*

#### B. Quota Logic Tests
| Test Step | Action | Expected | Result |
| :--- | :--- | :--- | :--- |
| **1. Limit** | Set limit to 2 active | Configured | **PASS** |
| **2. Add 2** | Create 2 active patients | Success | **PASS** |
| **3. Block** | Attempt 3rd active patient | Blocked (PLAN_QUOTA_EXCEEDED) | **PASS** |
| **4. Soft Del** | Soft-delete 1 patient | Quota -1 | **PASS** |
| **5. Add** | Create 3rd patient again | Success | **PASS** |
| **6. Status** | Set patient to 'inactive' | Quota -1 | **PASS** |
| **7. Add** | Create 4th patient | Success | **PASS** |

### 3. Guardrails Output
```text
Guardrail 'DOM sinks in app/Views' passed (0 match(es)).
Guardrail 'Group-based auth helpers' passed (0 match(es)).
Guardrail 'Raw tenant queries in controllers' passed (8 match(es)).
SaaS guardrail validation succeeded.
```

## 4. Closure Evidence (SQL Outputs)
**Command (PHP mysqli, local):**
```sql
SHOW COLUMNS FROM patients LIKE 'status';
SELECT COUNT(*) AS active_count_deleted_at FROM patients WHERE clinic_id=1 AND deleted_at IS NULL;
SELECT COUNT(*) AS active_count_status FROM patients WHERE clinic_id=1 AND deleted_at IS NULL AND status='active';
SELECT id, clinic_id, action_key, reason_code, meta_json, created_at
FROM plan_audits
WHERE clinic_id=1
ORDER BY created_at DESC
LIMIT 3;
```

**Output:**
```
SQL: SHOW COLUMNS FROM patients LIKE 'status'
Field	Type	Null	Key	Default	Extra
status	enum('active','inactive','archived')	YES	MUL	active	

SQL: SELECT COUNT(*) AS active_count_deleted_at FROM patients WHERE clinic_id=1 AND deleted_at IS NULL
active_count_deleted_at
3

SQL: SELECT COUNT(*) AS active_count_status FROM patients WHERE clinic_id=1 AND deleted_at IS NULL AND status='active'
active_count_status
2

SQL: SELECT id, clinic_id, action_key, reason_code, meta_json, created_at FROM plan_audits WHERE clinic_id=1 ORDER BY created_at DESC LIMIT 3
id	clinic_id	action_key	reason_code	meta_json	created_at
7	1	quota_check	PLAN_QUOTA_EXCEEDED	{"limit": 2, "metric": "patients_active_max", "current": 2}	2026-01-15 21:59:55
6	1	quota_check	PLAN_QUOTA_EXCEEDED	{"limit": 1, "metric": "patients_active_max", "current": 1}	2026-01-15 21:56:00
5	1	quota_check	PLAN_QUOTA_EXCEEDED	{"limit": 1, "metric": "patients_active_max", "current": 1}	2026-01-15 21:55:23
```
