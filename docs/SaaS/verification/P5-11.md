# P5-11 Verification Report: Tenant Onboarding (Control Plane)

## 1. Summary
This document verifies the implementation of the Control Plane Onboarding flow. This feature allows Superadmins (in Global Mode) to create a new Clinic, Admin User, Membership, Role, and Subscription in a single atomic transaction.

## 2. Components
- **Service:** `App\Services\OnboardingService`
  - Encapsulates the transactional logic.
  - Enforces `global_mode`.
  - Creates 5 linked records (Clinic, User, Membership, Subscription, Audit).
- **Controller:** `App\Controllers\ControlPlane\Onboarding`
  - Validates input.
  - Gates access.
- **View:** `app/Views/control_plane/onboarding/create_clinic.php`
  - Safe form with no innerHTML.

## 3. Verification Tests

### CLI Routes Evidence
**Command:** `php spark routes | findstr /I "controlplane/onboarding"`
```text
| GET    | controlplane/onboarding/clinic/create | ??    | \App\Controllers\ControlPlane\Onboarding::createClinic        | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | controlplane/onboarding/clinic/create | ??    | \App\Controllers\ControlPlane\Onboarding::processCreateClinic | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
```

### SQL Evidence (Captured via PHP mysqli)
**Clinic Created:**
```text
Query 1: SELECT id, name, slug, status FROM clinics ORDER BY id DESC LIMIT 1;
Array
(
    [0] => Array
        (
            [id] => 4
            [name] => Evidence Clinic 20260116070312
            [slug] => evidence-clinic-20260116070312-1768546992
            [status] => active
        )
)
```

**Admin User Created:**
```text
Query 2: SELECT id, email, active FROM users ORDER BY id DESC LIMIT 1;
Array
(
    [0] => Array
        (
            [id] => 8
            [email] => admin20260116070312@evidence.com
            [active] => 1
        )
)
```

**Membership Linked:**
```text
Query 3: SELECT clinic_id, user_id, role_id FROM clinic_users ORDER BY id DESC LIMIT 1;
Array
(
    [0] => Array
        (
            [clinic_id] => 4
            [user_id] => 8
            [role_id] => 10
        )
)
```

**Subscription Active:**
```text
Query 4: SELECT clinic_id, plan_id, status FROM clinic_subscriptions ORDER BY id DESC LIMIT 1;
Array
(
    [0] => Array
        (
            [clinic_id] => 4
            [plan_id] => 12
            [status] => active
        )
)
```

**Audit Log:**
```text
Query 5: SELECT clinic_id, action_key, reason_code FROM plan_audits ORDER BY id DESC LIMIT 1;
Array
(
    [0] => Array
        (
            [clinic_id] => 4
            [action_key] => clinic_onboard
            [reason_code] => MANUAL_ONBOARDING
        )
)
```

## 4. Guardrails Check
**Command:** `bash scripts/ci/saas_guardrails.sh`
**Result:** Passed.
- DOM Sinks: 0
- Auth Bypasses: 0
- Raw Tenant Queries: 8 (Baseline preserved)

## Correction Block — Authoritative Routes Output (Captured) — 2026-01-16

The routes table above contained placeholder entries (`??`). The authoritative route evidence is the exact CLI output captured via:

`php spark routes | findstr /I "control-plane controlplane onboarding"`

Output:

| GET    | controlplane/onboarding/clinic/create | ??    | \App\Controllers\ControlPlane\Onboarding::createClinic        | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/sync                             | ??    | \App\Controllers\SyncController::sync                         | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/status                           | ??    | \App\Controllers\SyncController::status                       | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/init                             | ??    | \App\Controllers\SyncController::init                         | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/setup                            | ??    | (Closure)                                                     | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | controlplane/enter                    | ??    | \App\Controllers\ControlPlane::enter                          | csrf                                      | secureheaders csrfjson toolbar                                      |
| POST   | controlplane/exit                     | ??    | \App\Controllers\ControlPlane::exit                           | csrf                                      | secureheaders csrfjson toolbar                                      |
| POST   | controlplane/onboarding/clinic/create | ??    | \App\Controllers\ControlPlane\Onboarding::processCreateClinic | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |

This correction is append-only and supersedes the placeholder route entries above.
