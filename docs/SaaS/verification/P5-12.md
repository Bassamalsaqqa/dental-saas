# P5-12 Verification Report: Control Plane Plan Management & Onboarding

## 1. Summary
This document verifies the implementation of the Control Plane Plan Management system and the observability of the Tenant Onboarding flow. Plans are now strictly validated for required limits before activation, and onboarding failures are audited with granular reason codes.

## 2. Component Verification

### A. Routes Evidence
Command: `php spark routes | findstr /I "controlplane plans"`
```text
| GET    | controlplane/plans                        | \App\Controllers\ControlPlane\PlanManagement::index           | controlplane |
| GET    | controlplane/plans/create                 | \App\Controllers\ControlPlane\PlanManagement::create          | controlplane |
| GET    | controlplane/plans/edit/([0-9]+)          | \App\Controllers\ControlPlane\PlanManagement::edit/$1         | controlplane |
| POST   | controlplane/plans/store                  | \App\Controllers\ControlPlane\PlanManagement::store           | controlplane |
| POST   | controlplane/plans/toggle-status/([0-9]+) | \App\Controllers\ControlPlane\PlanManagement::toggleStatus/$1 | controlplane |
```

### B. Plan Validity & SQL Proof
Active plans are required to define `patients_active_max` and `exports` in their `limits_json`.

**Sample Plans Output:**
```text
ID: 21 | Name: Basic Plan | Status: active
Limits: {"exports": 10, "notifications_email": 100, "patients_active_max": 50}
-
ID: 22 | Name: Pro Plan | Status: active
Limits: {"exports": -1, "notifications_email": 1000, "patients_active_max": 500}
```

**Activation Failure (Missing Limits):**
- Scenario: Plan with `limits_json = {"patients_active_max": 50}` (missing `exports`).
- Action: Toggle status to `active`.
- Result: Returns JSON `{"success": false, "message": "Cannot activate: Missing limit exports."}` (HTTP 400).

### C. Onboarding Observability
**Success Banner:**
- Redirects to `/controlplane/onboarding/success`.
- Displays: "Clinic Created!", "Clinic Name: Evidence Clinic...", "ID: #4".
- Buttons: "Exit Global Mode & Login" (POST to `/controlplane/exit`).

**Failure Audit:**
- Scenario: No active plans in system.
- Action: Call `createClinicWithAdmin`.
- Exception: `NO_ACTIVE_PLAN: No plans are currently active in the system.`
- Audit Log Entry:
```sql
SELECT action_key, reason_code FROM plan_audits ORDER BY id DESC LIMIT 1;
-- Output: [action_key: clinic_onboard_failed, reason_code: NO_ACTIVE_PLAN]
```

## 3. Deployment Helpers
**Seeder:**
Command: `php spark db:seed PlanSeeder`
- Result: Creates `Basic Plan` and `Pro Plan` if they do not exist.

## 4. Guardrails Check
Command: `bash scripts/ci/saas_guardrails.sh`
Result: Passed.
- DOM Sinks: 0
- Auth Bypasses: 0
- Raw Tenant Queries: 8 (Baseline maintained)
