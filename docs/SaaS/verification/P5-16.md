# Verification: P5-16 — Control Plane Operator Console v1

## Objective
Verify the read-only Operator Console implementation and confirm it does not introduce destructive actions or tenant-plane leakage.

## 1. Route Verification

**Command:**
```bash
php spark routes | findstr /I "controlplane console dashboard operations danger plans onboarding settings"
```

**Output:**
```
| GET    | controlplane/dashboard                | ??    | \App\Controllers\ControlPlane\Dashboard::index                | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/console                  | ??    | \App\Controllers\ControlPlane\Console::index                  | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/danger                   | ??    | \App\Controllers\ControlPlane\Danger::index                   | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/onboarding/clinic/create | ??    | \App\Controllers\ControlPlane\Onboarding::createClinic        | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | /                                     | ??    | \App\Controllers\Dashboard::index                             | csrf auth tenant                          | tenant auth secureheaders csrfjson toolbar                          |
| GET    | dashboard                             | ??    | \App\Controllers\Dashboard::index                             | csrf auth tenant permission:dashboard     | permission:dashboard tenant auth secureheaders csrfjson toolbar     |
| GET    | dashboard/stats                       | ??    | \App\Controllers\Dashboard::getStats                          | csrf auth tenant permission:dashboard     | permission:dashboard tenant auth secureheaders csrfjson toolbar     |
| GET    | dashboard/chart-data                  | ??    | \App\Controllers\Dashboard::getChartData                      | csrf auth tenant permission:dashboard     | permission:dashboard tenant auth secureheaders csrfjson toolbar     |
| GET    | notifications/ledger                  | ??    | \App\Controllers\NotificationLedger::index                    | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| GET    | settings                              | ??    | \App\Controllers\Settings::index                              | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| GET    | settings/backup                       | ??    | \App\Controllers\Settings::backup                             | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| GET    | settings/download-backup/([^/]+)      | ??    | \App\Controllers\Settings::downloadBackup/$1                  | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| GET    | settings/security                     | ??    | \App\Controllers\Settings::security                           | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| GET    | settings/notification-settings        | ??    | \App\Controllers\Settings::notifications                      | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| GET    | settings/channels                     | ??    | \App\Controllers\Settings::channels                           | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| GET    | rbac/sync                             | ??    | \App\Controllers\SyncController::sync                         | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/status                           | ??    | \App\Controllers\SyncController::status                       | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/init                             | ??    | \App\Controllers\SyncController::init                         | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/setup                            | ??    | (Closure)                                                     | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | controlplane/enter                    | ??    | \App\Controllers\ControlPlane::enter                          | csrf                                      | secureheaders csrfjson toolbar                                      |
| POST   | controlplane/danger/exit              | ??    | \App\Controllers\ControlPlane\Danger::exitGlobalMode          | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | controlplane/onboarding/clinic/create | ??    | \App\Controllers\ControlPlane\Onboarding::processCreateClinic | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | notifications/ledger/retry/([0-9]+)   | ??    | \App\Controllers\NotificationLedger::retry/$1                 | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/update                       | ??    | \App\Controllers\Settings::update                             | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/updateClinic                 | ??    | \App\Controllers\Settings::updateClinic                       | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/updateSystem                 | ??    | \App\Controllers\Settings::updateSystem                       | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/updateWorkingHours           | ??    | \App\Controllers\Settings::updateWorkingHours                 | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/create-backup                | ??    | \App\Controllers\Settings::createBackup                       | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/restore                      | ??    | \App\Controllers\Settings::restore                            | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/security/update              | ??    | \App\Controllers\Settings::updateSecurity                     | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/notifications/update         | ??    | \App\Controllers\Settings::updateNotifications                | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/updateRetention              | ??    | \App\Controllers\Settings::updateRetention                    | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/pruneExports                 | ??    | \App\Controllers\Settings::pruneExports                       | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/updateChannelStatus          | ??    | \App\Controllers\Settings::updateChannelStatus                | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
| POST   | settings/updateChannelConfig          | ??    | \App\Controllers\Settings::updateChannelConfig                | csrf auth tenant permission:settings      | permission:settings tenant auth secureheaders csrfjson toolbar      |
```

## 2. Exit Bypass Check

**Command:**
```bash
rg -n "controlplane/exit" app/Views app/Controllers
```

**Output:**
```
app/Controllers/ControlPlane.php:51:     * POST /controlplane/exit
```

## 3. SQL Evidence (MySQL CLI)

**Plans (Status Counts):**
```sql
SELECT status, COUNT(*) c FROM plans GROUP BY status;
```
**Output:**
```
ERROR 2002 (HY000): Can't connect to MySQL server on 'localhost' (10061)
```

**Clinics (Total Count):**
```sql
SELECT COUNT(*) c FROM clinics;
```
**Output:**
```
ERROR 2002 (HY000): Can't connect to MySQL server on 'localhost' (10061)
```

**Subscriptions (Active Count):**
```sql
SELECT status, COUNT(*) c FROM clinic_subscriptions GROUP BY status;
```
**Output:**
```
ERROR 2002 (HY000): Can't connect to MySQL server on 'localhost' (10061)
```

**Recent Plan Audits:**
```sql
SELECT created_at, action_key, reason_code, clinic_id FROM plan_audits ORDER BY id DESC LIMIT 10;
```
**Output:**
```
ERROR 2002 (HY000): Can't connect to MySQL server on 'localhost' (10061)
```

**Recent Notifications:**
```sql
SELECT channel_type, status, clinic_id, created_at FROM notifications ORDER BY id DESC LIMIT 10;
```
**Output:**
```
ERROR 2002 (HY000): Can't connect to MySQL server on 'localhost' (10061)
```

## 4. Guardrails

**Command:**
```bash
bash scripts/ci/saas_guardrails.sh
```

**Output:**
```
Guardrail 'DOM sinks in app/Views' passed (0 match(es)).
Guardrail 'Group-based auth helpers' passed (0 match(es)).
Guardrail 'Raw tenant queries in controllers' passed (8 match(es)).
SaaS guardrail validation succeeded.
```
## P5-16 SQL Evidence (Docker MySQL on 127.0.0.1:3307)

Commands executed (inside container):

```bash
docker exec -i mysql8-dental mysql -uroot -proot democa_dental_saas -e "SELECT status, COUNT(*) c FROM plans GROUP BY status;"
```
Output:
```
mysql: [Warning] Using a password on the command line interface can be insecure.
status	c
active	18
inactive	4
```

```bash
docker exec -i mysql8-dental mysql -uroot -proot democa_dental_saas -e "SELECT COUNT(*) c FROM clinics;"
```
Output:
```
mysql: [Warning] Using a password on the command line interface can be insecure.
c
5
```

```bash
docker exec -i mysql8-dental mysql -uroot -proot democa_dental_saas -e "SELECT status, COUNT(*) c FROM clinic_subscriptions GROUP BY status;"
```
Output:
```
mysql: [Warning] Using a password on the command line interface can be insecure.
status	c
active	4
```

```bash
docker exec -i mysql8-dental mysql -uroot -proot democa_dental_saas -e "SELECT created_at, action_key, reason_code, clinic_id FROM plan_audits ORDER BY id DESC LIMIT 10;"
```
Output:
```
mysql: [Warning] Using a password on the command line interface can be insecure.
created_at	action_key	reason_code	clinic_id
2026-01-16 08:58:05	test_audit	TEST	0
2026-01-16 08:42:04	clinic_onboard	MANUAL_ONBOARDING	5
2026-01-16 07:03:12	clinic_onboard	MANUAL_ONBOARDING	4
2026-01-16 06:55:38	clinic_onboard	MANUAL_ONBOARDING	3
2026-01-15 21:59:55	quota_check	PLAN_QUOTA_EXCEEDED	1
2026-01-15 21:56:00	quota_check	PLAN_QUOTA_EXCEEDED	1
2026-01-15 21:55:23	quota_check	PLAN_QUOTA_EXCEEDED	1
2026-01-15 21:52:01	quota_check	PLAN_QUOTA_EXCEEDED	1
2026-01-15 21:51:18	quota_check	PLAN_QUOTA_EXCEEDED	1
2026-01-15 21:43:36	feature_check	PLAN_FEATURE_DISABLED	1
```

```bash
docker exec -i mysql8-dental mysql -uroot -proot democa_dental_saas -e "SELECT channel_type, status, clinic_id, created_at FROM notifications ORDER BY id DESC LIMIT 10;"
```
Output:
```
mysql: [Warning] Using a password on the command line interface can be insecure.
channel_type	status	clinic_id	created_at
email	pending	1	2026-01-15 21:23:07
email	failed	1	2026-01-15 21:23:07
email	failed	1	2026-01-15 21:08:43
email	blocked	1	2026-01-15 21:08:43
email	failed	1	2026-01-15 21:07:53
email	blocked	1	2026-01-15 21:07:53
email	blocked	1	2026-01-15 21:06:31
email	blocked	1	0000-00-00 00:00:00
email	failed	1	0000-00-00 00:00:00
email	blocked	1	0000-00-00 00:00:00
```
