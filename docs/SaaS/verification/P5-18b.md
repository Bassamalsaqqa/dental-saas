# Verification: P5-18b — Control Plane 404 Diagnosis

## Objective
Identify why control-plane routes return 404 and confirm fix for superadmin in global_mode.

## 1. Filter Alias Confirmation

**Command:**
```bash
rg -n "controlplane" app/Config/Filters.php
```

**Output:**
```
38:        'controlplane'  => \App\Filters\ControlPlaneFilter::class,
```

## 2. ControlPlaneFilter Logic Paths

**File:** `app/Filters/ControlPlaneFilter.php`

**Fail-closed conditions:**
- Not logged in -> redirect to `/auth/login`
- `global_mode` missing/false -> 404
- `isSuperAdmin` false -> 404

## 3. Failure Reason Evidence (log excerpt)

**Log excerpt:** `writable/logs/log-2026-01-16.log`
```
WARNING - 2026-01-16 17:54:11 --> ControlPlaneFilter deny: global_mode missing or false for user_id=1
```

## 4. Routes Evidence

**Command:**
```bash
php spark routes | findstr /I "controlplane/dashboard controlplane/console controlplane/danger"
```

**Output:**
```
| GET    | controlplane/dashboard                | ??    | \App\Controllers\ControlPlane\Dashboard::index                | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/console                  | ??    | \App\Controllers\ControlPlane\Console::index                  | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/danger                   | ??    | \App\Controllers\ControlPlane\Danger::index                   | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | controlplane/danger/exit              | ??    | \App\Controllers\ControlPlane\Danger::exitGlobalMode          | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
```

## 5. Guardrails

**Command:**
```bash
bash scripts/ci/saas_guardrails.sh
```

**Output:**
```
Guardrail 'DOM sinks in app/Views' passed (0 match(es)).
Guardrail 'Group-based auth helpers' passed (0 match(es)).
Guardrail 'Raw tenant queries in controllers' passed (8 match(es)).
SaaS guardrail validation succeeded.
```

## 6. Post-Fix Expectation

When a superadmin enters Global Mode via `/controlplane/enter`, the control-plane routes should load without 404.
