# Verification: P5-20 — Control Plane Audit & Evidence Layer

## 1. Routes Sanity

**Command:**
```bash
php spark routes | findstr /I "controlplane"
```

**Output:**
```
| GET    | controlplane                          | ??    | \App\Controllers\ControlPlane\Entry::index                    | csrf                                      | secureheaders csrfjson toolbar                                      |
| GET    | controlplane/dashboard                | ??    | \App\Controllers\ControlPlane\Dashboard::index                | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/console                  | ??    | \App\Controllers\ControlPlane\Console::index                  | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/operations               | ??    | \App\Controllers\ControlPlane\Operations::index               | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/settings                 | ??    | \App\Controllers\ControlPlane\Settings::index                 | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/danger                   | ??    | \App\Controllers\ControlPlane\Danger::index                   | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | controlplane/onboarding/clinic/create | ??    | \App\Controllers\ControlPlane\Onboarding::createClinic        | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/sync                             | ??    | \App\Controllers\SyncController::sync                         | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/status                           | ??    | \App\Controllers\SyncController::status                       | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/init                             | ??    | \App\Controllers\SyncController::init                         | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| GET    | rbac/setup                            | ??    | (Closure)                                                     | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | controlplane/enter                    | ??    | \App\Controllers\ControlPlane::enter                          | csrf                                      | secureheaders csrfjson toolbar                                      |
| POST   | controlplane/danger/exit              | ??    | \App\Controllers\ControlPlane\Danger::exitGlobalMode          | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | controlplane/onboarding/clinic/create | ??    | \App\Controllers\ControlPlane\Onboarding::processCreateClinic | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
```

## 2. Contract Bans (Exit Isolation)

**Command:**
```bash
rg -n "controlplane/exit" app/Views app/Controllers
```

**Output:**
```
app/Controllers/ControlPlane.php:58:     * POST /controlplane/exit
app/Controllers/ControlPlane.php:73:            'route' => '/controlplane/exit'
```

## 3. Audit Storage (DB)

**Migration status:**
```bash
php spark migrate:status
```

**Output (excerpt):**
```
| App       | 2026-01-16-220000 | CreateControlPlaneAudits               | default | 2026-01-16 18:35:08 | 15    |
```

**Table exists:**
```bash
docker exec -i mysql8-dental mysql -uroot -proot democa_dental_saas -e "SHOW TABLES LIKE 'control_plane_audits';"
```

**Output:**
```
mysql: [Warning] Using a password on the command line interface can be insecure.
Tables_in_democa_dental_saas (control_plane_audits)
control_plane_audits
```

**Sample rows (after exercising flows in browser):**
```bash
docker exec -i mysql8-dental mysql -uroot -proot democa_dental_saas -e "SELECT id, created_at, actor_user_id, event_type, route, method FROM control_plane_audits ORDER BY id DESC LIMIT 25;"
```

**Output:**
```
mysql: [Warning] Using a password on the command line interface can be insecure.
```

## 4. Guardrails

**Command:**
```bash
bash scripts/ci/saas_guardrails.sh
```

**Output:**
```
Guardrail 'DOM sinks in app/Views' passed (0 match(es)).
Guardrail 'Group-based auth helpers' passed (0 match(es)).
Guardrail 'Raw tenant queries in controllers' passed (8 match(es)).
SaaS guardrail validation succeeded.
```
