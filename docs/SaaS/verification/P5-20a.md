# Verification: P5-20a â€” Control Plane Access Restoration

## Objective
Fix the "Fail-Closed 404" issue preventing superadmins from accessing the Control Plane entry page (`/controlplane`), caused by incorrect application of the `controlplane` filter (which requires Global Mode) to the entry route itself.

## 1. Route Verification (Post-Fix)

**Command:**
```bash
php spark routes | findstr /I "controlplane"
```

**Output:**
```
| GET    | controlplane                          | ??    | \App\Controllers\ControlPlane\Entry::index                    | csrf                                      | secureheaders csrfjson toolbar                                      |
| GET    | controlplane/dashboard                | ??    | \App\Controllers\ControlPlane\Dashboard::index                | csrf controlplane                         | controlplane secureheaders csrfjson toolbar                         |
| POST   | controlplane/enter                    | ??    | \App\Controllers\ControlPlane::enter                          | csrf                                      | secureheaders csrfjson toolbar                                      |
```
*Note: `controlplane` and `controlplane/enter` NO LONGER have the `controlplane` filter. `dashboard` and others RETAIN it.*

## 2. Root Cause Analysis
- **Issue:** The `controlplane` route group in `app/Config/Routes.php` implicitly applied the `controlplane` filter to ALL routes, or the filter logic was assumed to be granular.
- **Evidence:** Users visiting `/controlplane` received 404 because `ControlPlaneFilter` checks for `global_mode === true`. Since they hadn't entered yet, it failed closed.
- **Fix:** Explicitly split the `controlplane` route group into two:
    1.  **Entry Group:** Unfiltered (except CSRF/Auth implicit). Protected by `Entry::index` manual `isSuperAdmin` check.
    2.  **Protected Group:** Filtered with `['filter' => 'controlplane']` requiring Global Mode.

## 3. Security Contract Verification
- **Entry (`/controlplane`):** Accessible to SuperAdmin without Global Mode. (Validated by route config).
- **Enter (`POST /controlplane/enter`):** Accessible to SuperAdmin without Global Mode. (Validated by route config).
- **Dashboard (`/controlplane/dashboard`):** inaccessible without Global Mode (404 via Filter). (Validated by route config).
- **Exit Isolation:** `rg -n "controlplane/exit" app/Views app/Controllers` shows only method definition. (Validated).

## 4. Guardrails
`bash scripts/ci/saas_guardrails.sh` -> **Passed.**
