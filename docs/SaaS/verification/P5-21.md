# Verification: P5-21 Subscription Enforcement & Plan Gatekeeping

## 1. Context
- **Objective:** Enforce fail-closed subscription standing and granular plan limits (quotas) with 404 concealment.
- **Components:** `SubscriptionFilter`, `PlanGuard`, `ClinicSubscriptionModel`.

## 2. Changes Implemented
- **Filter:** `app/Filters/SubscriptionFilter.php` (404 on invalid standing + Forensic logging).
- **Service:** `app/Services/PlanGuard.php` (Refactored for 404s, forensic logging, and deterministic standing invariants).
- **Model:** `app/Models/ClinicSubscriptionModel.php` (Added date-based `getCurrentSubscription`).
- **Enforcement:** `app/Controllers/Patient.php` calls `PlanGuard` in `store()` and rethrows 404s.

## 3. Verification Steps

### A) Authenticated subscription gate (404 + SUBSCRIPTION_STATE_BLOCK log)
1. **Action:** Suspend clinic in DB (`UPDATE clinic_subscriptions SET status='suspended' WHERE clinic_id=1`).
2. **Action:** Authenticate as tenant user and hit `/dental-saas/dashboard`.
3. **Evidence:** 
   - HTTP Response Header:
     PASTE VERBATIM OUTPUT HERE
   - Log Entry:
     PASTE VERBATIM OUTPUT HERE

### B) Authenticated quota gate (404 + PLAN_QUOTA_BLOCK log)
1. **Action:** Set `patients_active_max` to 0 in plan.
2. **Action:** Authenticate and attempt `POST /dental-saas/patients/store` (requires CSRF + Cookie).
3. **Evidence:**
   - HTTP Response Header:
     PASTE VERBATIM OUTPUT HERE
   - Log Entry:
     PASTE VERBATIM OUTPUT HERE

### C) Missing context gate (404 + SUBSCRIPTION_CONTEXT_MISSING log)
1. **Action:** Clear `active_clinic_id` from session and hit `/dental-saas/dashboard`.
2. **Evidence:**
   - HTTP Response Header:
     PASTE VERBATIM OUTPUT HERE
   - Log Entry:
     PASTE VERBATIM OUTPUT HERE

### D) Code integrity rg output for getCurrentSubscription
1. **Command:** `rg -n "getCurrentSubscription" app/Models/ClinicSubscriptionModel.php -A 10`
2. **Evidence:**
   PASTE VERBATIM OUTPUT HERE

## 4. Outcome
- **Status:** **PENDING** (Verification evidence required)
- **Impact:** Entire tenant plane is protected by subscription standing and plan limits with full 404 concealment.