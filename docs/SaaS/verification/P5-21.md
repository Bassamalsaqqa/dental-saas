# Verification: P5-21 Subscription Enforcement & Plan Gatekeeping

## 1. Context
- **Objective:** Enforce fail-closed subscription standing and granular plan limits (quotas) with 404 concealment.
- **Components:** `SubscriptionFilter`, `PlanGuard`, `ClinicSubscriptionModel`.

## 2. Changes Implemented
- **Filter:** `app/Filters/SubscriptionFilter.php` (404 on invalid standing + Forensic logging).
- **Service:** `app/Services/PlanGuard.php` (Refactored for 404s, forensic logging, and deterministic standing invariants).
- **Model:** `app/Models/ClinicSubscriptionModel.php` (Added date-based `getCurrentSubscription`).
- **Enforcement:** `app/Controllers/Patient.php` calls `PlanGuard` in `store()` and rethrows 404s.

## 3. Verification Steps

### A) Authenticated subscription gate (404 + SUBSCRIPTION_STATE_BLOCK log)
1. **Action:** Suspend clinic in DB (`UPDATE clinic_subscriptions SET status='suspended' WHERE clinic_id=1`).
2. **Action:** Authenticate as tenant user and hit `/dental-saas/dashboard`.
3. **Evidence:** 
   - HTTP Response Header:
     PASTE VERBATIM OUTPUT HERE
   - Log Entry:
     PASTE VERBATIM OUTPUT HERE

### B) Authenticated quota gate (404 + PLAN_QUOTA_BLOCK log)
1. **Action:** Set `patients_active_max` to 0 in plan.
2. **Action:** Authenticate and attempt `POST /dental-saas/patients/store` (requires CSRF + Cookie).
3. **Evidence:**
   - HTTP Response Header:
     PASTE VERBATIM OUTPUT HERE
   - Log Entry:
     PASTE VERBATIM OUTPUT HERE

### C) Missing context gate (404 + SUBSCRIPTION_CONTEXT_MISSING log)
1. **Action:** Clear `active_clinic_id` from session and hit `/dental-saas/dashboard`.
2. **Evidence:**
   - HTTP Response Header:
```
HTTP/1.1 404 Not Found
Date: Sat, 17 Jan 2026 09:06:24 GMT
Server: Apache/2.4.58 (Win64) OpenSSL/3.1.3 PHP/8.2.12
X-Powered-By: PHP/8.2.12
Cache-Control: no-store, max-age=0, no-cache
Content-Type: application/json; charset=UTF-8
```
   - Log Entry:
     PASTE VERBATIM SUBSCRIPTION_CONTEXT_MISSING LOG EXCERPT HERE

### D) Code integrity rg output for getCurrentSubscription
1. **Command:** `rg -n "getCurrentSubscription" app/Models/ClinicSubscriptionModel.php -A 10`
2. **Evidence:**
```
34:    public function getCurrentSubscription(int $clinicId)
35-    {
36-        return $this->where('clinic_id', $clinicId)
37-                    ->whereIn('status', ['active', 'trial'])
38-                    ->orderBy("CASE 
39-                        WHEN status = 'active' THEN COALESCE(end_at, '9999-12-31') 
40-                        ELSE COALESCE(trial_ends_at, '9999-12-31') 
41-                    END", 'DESC', false)
42-                    ->orderBy('id', 'DESC')
43-                    ->first();
44-    }
```

## 4. Outcome
- **Status:** **PENDING** (Verification evidence required)
- **Impact:** Entire tenant plane is protected by subscription standing and plan limits with full 404 concealment.