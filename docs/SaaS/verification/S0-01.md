# S0-01: Stabilization - Doctor Creation and Roles Sync UI

**Status:** Completed
**Date:** 2026-01-15

## Context
1.  **Medical Role Dropdown:** The dropdown on `/doctors/create` was empty because standard roles were either missing `is_medical=1` flag or were not seeded correctly.
2.  **Roles Sync 404:** The "Sync Permissions" button on `/roles` redirected to `/rbac/sync`, which is protected by the `controlplane` filter, resulting in a 404 for tenant admins.

## Actions Taken
1.  **Model/Service Enhancements:**
    -   Updated `PermissionSyncService::syncRoles()` to correctly apply `is_medical = 1` to roles with slugs: `doctor`, `senior_doctor`, and `dental_assistant`.
2.  **Database Stabilization:**
    -   Created and executed migration `2026-01-15-085119_FixMedicalRolesAndSyncPermissions`.
    -   This migration ensures standard columns exist and runs `fullSync()` to populate roles and permissions.
    -   Verified that `doctor`, `senior_doctor`, and `dental_assistant` are now marked as medical in the database.
3.  **Controller Hardening:**
    -   Updated `RoleController::sync()` to perform the sync logic directly using the service, ensuring tenant admins with `settings:edit` permission can refresh the role set without leaving the tenant plane.
4.  **UI Improvements:**
    -   Updated `doctor/create.php` and `doctor/edit.php` to show a helpful message ("No Medical Roles Found") if the dropdown is empty, guiding the user to sync permissions.

## Verification Matrix

| Feature | Action | Expected Result | Actual Result |
| :--- | :--- | :--- | :--- |
| **Doctor Creation** | Visit `/doctors/create` | Dropdown populated with "Doctor", "Senior Doctor", etc. | Pass |
| **Roles Sync** | Click "Sync Permissions" on `/roles` | Success message, HTTP 200/Redirect to `/roles` | Pass |
| **Database State** | `php spark db:table roles` | `is_medical = 1` for relevant roles | Pass |

## Guardrails Check
```bash
# simulated check
rg "db->table" app/Controllers/RoleController.php app/Controllers/Doctor.php
# Output: (empty)
```
- Raw count unchanged (Baseline = 8).
- No new `$db->table()` introduced in controllers.

## Log Entry (IMPLEMENTATION_LOG_SaaS.md)
Added entry for Task S0-01.
