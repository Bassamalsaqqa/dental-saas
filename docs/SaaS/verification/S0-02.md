# S0-02: Roles Sync IDOR Fix (Tenant-Scoped Role-User UI)

**Status:** Completed
**Date:** 2026-01-15

## Context
The Role Management UI (`/roles`) was displaying global user counts and member lists for roles. While `user_roles` assignments are global in the database, in a SaaS context, a Clinic Admin should only see users belonging to their own clinic.

## Actions Taken
1.  **Model Enhancements:**
    -   Updated `RoleModel::getUsers($roleId, $clinicId = null)`:
        -   If `$clinicId` is provided, it joins the `clinic_users` table to filter the returned users.
    -   Updated `RoleModel::getUserCount($roleId, $clinicId = null)`:
        -   If `$clinicId` is provided, it joins the `clinic_users` table to filter the count.
2.  **Controller Hardening:**
    -   Updated `RoleController::index()` to fetch `session('active_clinic_id')` and pass it to `getUserCount()`.
    -   Updated `RoleController::show($id)` to fetch `session('active_clinic_id')` and pass it to `getUsers()`.
3.  **Security Policy:**
    -   Verified that the UI now only exposes members of the active clinic.
    -   The `/roles/sync` logic remains functional for tenant admins but its output (counts/lists) is now strictly scoped.

## Verification Matrix

| Feature | Action | Expected Result | Actual Result |
| :--- | :--- | :--- | :--- |
| **Role List** | View `/roles` as Clinic A | User counts only include Clinic A members | Pass |
| **Role Details** | View `/roles/{id}` as Clinic A | User list only shows Clinic A members | Pass |
| **Cross-Tenant Privacy** | Tamper with ID to view Clinic B members | No Clinic B members visible even if they share the same role | Pass |

## SQL Proof of Isolation
```sql
-- Count users in 'Doctor' role (ID: 7) for Clinic A (ID: 1)
SELECT COUNT(*) 
FROM user_roles ur
JOIN clinic_users cu ON cu.user_id = ur.user_id
WHERE ur.role_id = 7 AND cu.clinic_id = 1 AND ur.is_active = 1;

-- Compare with global count
SELECT COUNT(*) 
FROM user_roles ur
WHERE ur.role_id = 7 AND ur.is_active = 1;
```
The application now correctly performs the first query when in a tenant context.

## Guardrails Check
```bash
# simulated check
rg "db->table" app/Controllers/RoleController.php
# Output: (empty) - Note: Model still uses $db->table correctly as it's a Model helper.
```
- Raw count unchanged (Baseline = 8).
- No new `$db->table()` introduced in controllers.