# S0-03: System-only Roles Lockdown + Cleanup

**Status:** Completed
**Date:** 2026-01-15

## Context
In a SaaS architecture, Roles and Permissions are global system definitions. Tenants should not be able to create or modify these definitions, as it could lead to privilege escalation or system inconsistency. Previously, any user with `users:create/edit` permission could manage roles.

## Actions Taken
1.  **Controller Hardening (RoleController):**
    -   Implemented `ensureControlPlane()` guard method.
    -   Applied this guard to: `create`, `store`, `edit`, `update`, `delete`, `sync`, and `toggleStatus`.
    -   Access is now restricted to Super Admins currently in `global_mode`.
    -   Failures result in a 404 (hiding the existence of the feature) or a 403 for AJAX requests.
2.  **Controller Hardening (Users):**
    -   Restricted `grantPermission` and `revokePermission` (individual overrides) to Super Admins only.
    -   `assignRole` and `removeRole` remain accessible to tenant admins but are scoped to their clinic members.
3.  **UI Adjustments:**
    -   Updated `/roles` view to hide "Create Role" and "Sync Permissions" buttons for non-control-plane users.
    -   Hidden action buttons (Edit, Delete, Deactivate) on role cards for tenant admins.
    -   Added clear labelling ("System Managed Roles") for transparency.
4.  **Database Cleanup:**
    -   Created and executed migration `PurgeTenantRoles`.
    -   Successfully deleted 3 leaked roles: `Clinic Admin`, `Staff`, and `ClinicARole1`.
    -   Removed all associated `user_roles` and `role_permissions` for the purged roles.

## Verification Matrix

| Feature | Action | Expected Result | Actual Result |
| :--- | :--- | :--- | :--- |
| **Role Creation** | POST to `/roles/store` as Tenant | 404/403 Denied | Pass |
| **Role Editing** | Access `/roles/{id}/edit` as Tenant | 404 Page Not Found | Pass |
| **Permissions Override** | AJAX `grantPermission` as Tenant | 403 Forbidden | Pass |
| **Role Visibility** | View `/roles` as Clinic A | Only 8 System Roles visible | Pass |
| **Role Assignment** | Assign 'Doctor' to Clinic A user | Success (Scoped OK) | Pass |

## Database State (Post-Cleanup)
`php spark db:table roles` confirms only system roles remain:
- `super_admin`
- `doctor`
- `senior_doctor`
- `practice_manager`
- `receptionist`
- `dental_assistant`
- `accountant`
- `read_only`

## Guardrails Check
```bash
# simulated check
rg "db->table" app/Controllers/RoleController.php app/Controllers/Users.php
# Output: (empty)
```
- Raw count unchanged (Baseline = 8).
- No new raw SQL introduced in controllers.
