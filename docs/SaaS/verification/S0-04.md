# S0-04: Clinic Switcher Dropdown (secure tenant context switching)

**Status:** Completed & Refined
**Date:** 2026-01-15

## Context
Users belonging to multiple clinics need a secure and convenient way to switch between their memberships without re-authenticating. The switcher must be gated by membership validation and correctly reset tenant context.

## Actions Taken
1.  **Backend Implementation:**
    -   Updated `ClinicService` with context clearing and membership retrieval helpers.
    -   Enhanced `BaseController` to globally inject `user_memberships` into all views.
    -   Added `ClinicSelector::switch($clinicId)` endpoint with strict membership validation.
    -   Added GET route `/clinic/switch/(:num)` for secure switching.
2.  **UI Implementation:**
    -   Modified `app/Views/layouts/main_auth.php` to include a "Switch Clinic" dropdown in the header.
    -   **Refinement (Post-Review):** Moved switcher to the **top-right** of the header for better visibility and logic.
    -   Implemented conditional visibility: dropdown only appears if `count(user_memberships) > 1`.
    -   Added JS handlers for toggling and clicking outside the switcher.
    -   Enhanced UI with clinic icons, active state highlighting, and a "View All" footer.
3.  **Security Integration:**
    -   Context switching triggers session regeneration.
    -   Permissions cache is cleared on every switch to ensure the new clinic's RBAC rules are applied.
    -   Fail-closed: Attempting to switch to a non-member clinic results in a `404 Page Not Found` error.

## Verification: Single-Clinic User
**Scenario:** User belongs only to "Dental One".
**Result:** 
-   The "Switch Clinic" button is **hidden** in the header.
-   Data remains scoped to "Dental One".

## Verification: Multi-Clinic User
**Scenario:** User belongs to "Dental One" and "Dental Two".
**Result:**
-   The "Switch Clinic" button is **visible** in the top-right toolbar.
-   Button shows current clinic name and a building icon.
-   Dropdown lists both clinics with "Hospital" icons.
-   Current clinic is highlighted with a blue background and check icon.

## Verification: Successful Switch
**Action:** Click "Dental Two" in the switcher.
**Result:**
-   Redirected to `/dashboard`.
-   Success message: "Switched to Dental Two".
-   Session keys updated: `active_clinic_id` is now 2.
-   Header and sidebar update to reflect "Dental Two".

## Verification: Unauthorized Switch (Fail-Closed)
**Action:** Manually navigate to `/clinic/switch/999` (non-member clinic).
**Result:**
-   `404 Page Not Found` (Exception thrown after validation fail).
-   Tenant context is NOT updated.

## Guardrails Check
- No `$db->table()` introduced in controllers.
- Baseline Raw Count: 8.
- Current Raw Count: 8.