# Verification: S2-02 Active clinic session contract

## Objective
Ensure login flow sets or clears session keys based on membership count.

## 1. Logic Verification (Code Review)
**File:** `app/Controllers/Auth.php`
**Method:** `login()`

**Logic Implemented:**
```php
// 1. Clear global mode and tenant keys
$this->session->set('global_mode', false);
$this->session->remove(['active_clinic_id', 'active_clinic_role_id']);

// 2. Query memberships
$memberships = $db->table('clinic_users')->...->get()->getResultArray();
$count = count($memberships);

// 3. Branching
if ($count === 1) {
    // Auto-select
    $this->session->set('active_clinic_id', $m['clinic_id']);
    return redirect()->to('/dashboard');
} elseif ($count > 1) {
    // Wall
    return redirect()->to('/clinic/select');
} else {
    // No Clinic
    return redirect()->to('/clinic/no-clinic');
}
```

## 2. Session Contract
- Keys `active_clinic_id` and `active_clinic_role_id` are ONLY set here or in `ClinicSelector`.
- `global_mode` is explicitly disabled.
- Logout clears session (destroy).

## 3. Test Scenarios
- **User 1 (2 clinics):** Login -> Redirect to `/clinic/select`. Session keys empty.
- **User 2 (1 clinic):** Login -> Redirect to `/dashboard`. Session keys set.
- **User with 0 clinics:** Login -> Redirect to `/clinic/no-clinic`.
