# Verification: S4-02a â€“ Patients DataTables scoping

## Objective
Scope `Patient::getData()` to the current clinic so `/patient/get-data` returns only rows where `clinic_id = session('active_clinic_id')`.

## 1. Route Evidence
**Command:** `php spark routes | grep patient/get-data`
**Result:**
```
| POST      | patient/get-data                                | \App\Controllers\Patient::getData                      |
| GET       | patient/get-data                                | \App\Controllers\Patient::getData                      |
```

## 2. Implementation Verification
**File:** `app/Controllers/Patient.php`
**Logic:**
```php
$clinicId = session()->get('active_clinic_id');
if (!$clinicId) {
    return $this->response->setStatusCode(403)->setJSON(['error' => 'TENANT_CONTEXT_REQUIRED']);
}

$totalRecords = $this->patientModel->where('clinic_id', $clinicId)->countAllResults(false);
// ...
$builder = $this->patientModel->where('clinic_id', $clinicId);
// ...
$patients = $builder->orderBy('created_at', $orderDir)
    ->limit($length, $start)
    ->find();
```

## 3. Runtime Verification Steps
1. Login as a user with access to multiple clinics (e.g., Clinic A and Clinic B).
2. Select **Clinic A**.
3. Create a patient "Patient A".
4. View the patient list; "Patient A" is visible.
5. Switch to **Clinic B**.
6. View the patient list; "Patient A" is **NOT** visible.
7. Create a patient "Patient B".
8. View the patient list; "Patient B" is visible.
9. Switch back to **Clinic A**.
10. View the patient list; "Patient A" is visible, "Patient B" is **NOT** visible.

11. Inspect the JSON response (e.g., via browser DevTools or `curl -X POST http://localhost/patient/get-data`). Each payload now contains `recordsTotal`/`recordsFiltered` equal to the number of returned rows (clinic-scoped). For example:
```
{
  "draw": 1,
  "recordsTotal": 5,
  "recordsFiltered": 5,
  "data": [ ... Clinic A rows only ... ]
}
```
Switch clinics and confirm the totals change accordingly (Clinic B totals match its rows). This proves both the data and the metadata are scoped.

## 4. Fail-Closed Verification
If a request is made to `/patient/get-data` without an active clinic ID in the session:
**Expected Response:** `HTTP 403 Forbidden` with body `{ "error": "TENANT_CONTEXT_REQUIRED" }`.

## 5. Diagnostic Cleanup
The `[TENANT-DIAG]` instrumentation introduced in Task D-01 has been removed from `app/Controllers/Patient.php`.
