# Verification: S4-02b â€“ Activity Log listing scoping (FIX)

## Objective
Remove cross-clinic leakage from the Activity Log feed by scoping every read to `clinic_id = session('active_clinic_id')`. Ensure compliance with guardrails by removing raw database queries from the controller.

## 1. Route Evidence
**Command:** `php spark routes | findstr -i "activity-log"`
**Result:**
```
| GET       | activity-log                                    | \App\Controllers\ActivityLog::index                    |
| GET       | activity-log/api                                | \App\Controllers\ActivityLog::api                      |
```

## 2. Guardrail Compliance Proof
**Command:** `rg -n "table\(" app/Controllers/ActivityLog.php`
**Result:** (empty) - All raw database table calls removed from the controller.

**Command:** `rg -n "builder\(" app/Controllers/ActivityLog.php`
**Result:** (empty) - All raw builder calls removed from the controller.

## 3. Implementation Verification
**File:** `app/Models/ActivityLogModel.php`
**Logic:** Implemented clinic-scoped methods:
- `getActivitiesByClinic($clinicId, ...)`
- `countActivitiesByClinic($clinicId, ...)`
- `getFiltersByClinic($clinicId)`
- `getEntityActivities($entityType, $entityId, $limit, $clinicId)`
- `getUserActivities($userId, $limit, $clinicId)`

**File:** `app/Controllers/ActivityLog.php`
**Logic:** Refactored all data retrieval to call the new model methods with `clinicId` from session.
```php
$clinicId = session()->get('active_clinic_id');
// ...
$activities = $this->activityLogModel->getActivitiesByClinic($clinicId, ...);
```

## 4. Reproduction Steps (Verification)
1. **Clinic A**: Create a new patient. (This logs an activity).
2. **Switch to Clinic B** via `/clinic/switch`.
3. Visit `/activity-log`.
4. **Expectation:** The "New Patient" activity from Clinic A is NOT visible.
5. **JSON Check**: Inspect `/activity-log/api` response for both clinics; `total` count and `activities` array correctly filter by the active clinic.

## 5. Allowlist Hygiene
Successfully removed 4 entries from `docs/SaaS/guardrails/raw-tenant-queries.allowlist` corresponding to `ActivityLog.php`.
The controller is now completely clean of raw database builders.

## 6. Fail-Closed Test
API request to `/activity-log/api` without session returns `403` JSON:
```json
{"error": "TENANT_CONTEXT_REQUIRED"}
```