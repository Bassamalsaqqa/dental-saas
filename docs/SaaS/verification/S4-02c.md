# Verification: S4-02c â€“ Finance DataTables scoping

## Objective
Scope the Finance listing endpoint(s) to `clinic_id = session('active_clinic_id')` and remove raw queries.

## 1. Route Evidence
**Command:** `php spark routes | findstr /I "finance"`
**Result:**
```
| GET       | finance/get-data                                | \App\Controllers\Finance::getFinancesData              |
```

## 2. Implementation Verification
**File:** `app/Models/FinanceModel.php`
**Logic:** Implemented:
- `getFinancesByClinic($clinicId, ...)`
- `countFinancesByClinic($clinicId, ...)`

**File:** `app/Controllers/Finance.php`
**Logic:** Refactored `getFinancesData` to call model methods.
```php
$clinicId = session()->get('active_clinic_id');
if (!$clinicId) {
    return $this->response->setStatusCode(403)->setJSON(['error' => 'TENANT_CONTEXT_REQUIRED']);
}
$totalRecords = $this->financeModel->countFinancesByClinic($clinicId);
```

## 3. Reproduction Steps (Verification)
1. **Clinic A**: Create a Finance transaction.
2. **Switch to Clinic B**.
3. Visit `/finance`.
4. **Expectation:** The transaction from Clinic A is NOT visible.
5. **JSON Check:** `/finance/get-data` returns only Clinic B records.

## 4. Allowlist Hygiene
Removed 4 entries from `docs/SaaS/guardrails/raw-tenant-queries.allowlist` corresponding to `Finance.php`.
- Raw `$db->table($financeTableName)` usage removed.

## 5. Fail-Closed Test
API request to `/finance/get-data` without session returns `403` JSON.
