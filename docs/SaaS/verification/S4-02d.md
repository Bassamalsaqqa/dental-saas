# Verification: S4-02d â€“ Appointments DataTables scoping

## Objective
Scope the Appointments list/DataTables endpoints so that Clinic A data never leaks into Clinic B. Ensure joins (patients) include an explicit clinic_id predicate.

## 1. Route Evidence
**Command:** `php spark routes | findstr -i "appointment"`
**Result:**
```
| GET       | appointment                                     | \App\Controllers\Appointment::index                    |
| GET       | appointment/loadMoreAppointments                | \App\Controllers\Appointment::loadMoreAppointments     |
| GET       | appointment/calendar-events                     | \App\Controllers\Appointment::getCalendarEvents        |
```

## 2. Implementation Verification
**File:** `app/Models/AppointmentModel.php`
**Logic:** Implemented:
- `getAppointmentsByClinic($clinicId, ...)`
- `countAppointmentsByClinic($clinicId, ...)`
- `getAppointmentsByDateByClinic($clinicId, $date)`
- `getCalendarAppointmentsByClinic($clinicId, $start, $end)`
- `getAppointmentStatsByClinic($clinicId)`
- Updated `checkTimeSlotAvailability($date, $time, $duration, $excludeId)`

**Join Guard Example:**
```php
$query = $this->select('appointments.*, patients.first_name, ...')
    ->join('patients', 'patients.id = appointments.patient_id')
    ->where('appointments.clinic_id', $clinicId)
    ->where('patients.clinic_id', $clinicId); // Extra join guard
```

**File:** `app/Controllers/Appointment.php`
**Logic:** Refactored `index`, `loadMoreAppointments`, `getCalendarEvents`, and `calendar` to call scoped model methods. Added fail-closed check for `active_clinic_id`.

## 3. Reproduction Steps (Verification)
1. **Clinic A**: Create an appointment.
2. **Switch to Clinic B** via `/clinic/switch`.
3. Visit `/appointment`.
4. **Expectation:** The appointment from Clinic A is NOT visible.
5. **Calendar Check**: Visit `/appointment/calendar`. Clinic A's appointment is not visible in Clinic B's calendar.

## 4. Guardrail Compliance
**Command:** `rg -n "db->table|builder\(" app/Controllers/Appointment.php`
**Result:** (empty) - No raw builders remain in the controller.

## 5. Fail-Closed Test
AJAX request to `/appointment/loadMoreAppointments` without session returns `403` JSON error.
