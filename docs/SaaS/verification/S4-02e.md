# Verification: S4-02e â€” Patient search/autocomplete scoping for appointments

## Objective
Scope the patient picker search endpoints so only patients in `session('active_clinic_id')` are returned.

## 1. Route Evidence
**Command:** `php spark routes | findstr /I "api/search/patients"`
**Result:**
```
| GET       | api/search/patients                            | \App\Controllers\Api\Search::patients                  |
```

## 2. Implementation Verification
### Model Scoping
**File:** `app/Models/PatientModel.php`
**Method:** `searchPatientsByClinic($clinicId, $searchTerm, $limit)`
**Logic:**
```php
$builder = $this->where('clinic_id', $clinicId)
                ->where('status', 'active');
// ... search filters ...
return $builder->orderBy('first_name', 'ASC')->limit($limit)->findAll();
```

### Controller Enforcement
**File:** `app/Controllers/Api/Search.php`
**Method:** `patients()`
**Logic:**
```php
$clinicId = session()->get('active_clinic_id');
if (!$clinicId) {
    return $this->response->setStatusCode(403)->setJSON(['error' => 'TENANT_CONTEXT_REQUIRED']);
}
// ...
$patients = $this->patientModel->searchPatientsByClinic($clinicId, $query, $limit);
```

## 3. Reproduction Steps (Verification)
1. **Clinic A**: Create a patient "Patient A".
2. **Clinic B**: Create a patient "Patient B".
3. **Switch to Clinic A**: Open Appointment form.
   - Search for "Patient"; only "Patient A" appears in the dropdown.
4. **Switch to Clinic B**: Open Appointment form.
   - Search for "Patient"; only "Patient B" appears in the dropdown.

## 4. Network/JSON Proof
**Clinic A Request:** `GET /api/search/patients?q=Patient`
**Expected Response:**
```json
{
    "results": [
        {"id": 1, "text": "Patient A", "value": 1}
    ],
    "total": 1
}
```

**Clinic B Request:** `GET /api/search/patients?q=Patient`
**Expected Response:**
```json
{
    "results": [
        {"id": 2, "text": "Patient B", "value": 2}
    ],
    "total": 1
}
```

## 5. Guardrail Compliance
**Command:** `rg -n "table\(" app/Controllers/Api/Search.php`
**Result:** (empty) - The controller uses Model methods and does not perform raw database queries.

## 6. Fail-Closed Test
Request to `/api/search/patients` without an active clinic session returns `403` JSON error.
