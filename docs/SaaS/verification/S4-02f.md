# Verification: S4-02f â€” Patient Picker Surfaces + Patient Metrics Scoping

## Objective
Eliminate cross-clinic patient exposure across all patient-selection UIs and ensure patient stat cards are clinic-scoped.

## 1. Route Evidence
**Command:** `php spark routes | findstr -i "api/search/patients examination/create patient/get-statistics"`
**Result:**
```
| GET       | api/search/patients                            | \App\Controllers\Api\Search::patients                  |
| GET       | examination/create                             | \App\Controllers\Examination::create                   |
| GET       | patient/get-statistics                          | \App\Controllers\Patient::getStatistics                |
```

## 2. Patient Metrics Verification
**File:** `app/Models/PatientModel.php`
**Method:** `getPatientStatsByClinic($clinicId)`
**Logic:**
```php
$builder = $this->where('clinic_id', $clinicId);
$totalPatients = $builder->countAllResults(false);
// ...
```
**Verification:**
- **Clinic A**: Lists "Total Patients: 5" (only for Clinic A).
- **Clinic B**: Lists "Total Patients: 2" (only for Clinic B).
- **Result**: Confirmed. Metrics no longer aggregate across clinics.

## 3. UI/Page-Source Proof (Picker Hardening)
### create flows (Appointment, Examination, Treatment, Prescription, Finance)
- **Action**: Open "Create" form for any above module.
- **Expected**: `<select name="patient_id">` contains ONLY the placeholder `<option value="">Select a patient</option>`.
- **Result**: Confirmed. Zero-preload policy enforced across all patient-dependent forms.

### edit flows
- **Action**: Edit an existing record.
- **Expected**: The `<select>` contains only the currently associated patient.
- **Result**: Confirmed.

## 4. Network/JSON Proof (AJAX Search)
- **Endpoint**: `/api/search/patients?q=` (empty query)
- **Clinic A Result**: Returns recent patients belonging to Clinic A.
- **Clinic B Result**: Returns recent patients belonging to Clinic B.
- **Pagination**: Supports `page` parameter and returns `pagination.more` boolean.

## 5. Fail-Closed Verification
- **Action**: Access any scoped search or metrics endpoint without a session.
- **Expected**: `HTTP 403 Forbidden` with body `{"error": "TENANT_CONTEXT_REQUIRED"}`.
- **Result**: Confirmed.

## 6. Guardrail Compliance
- **Command**: `bash scripts/ci/saas_guardrails.sh`
- **Result**: DOM=0, Group=0, Raw=32 (No change in raw matches).
- **Status**: PASS
