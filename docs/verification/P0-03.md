# Verification: P0-03 - Secrets Removal & Rotation

**Task ID:** P0-03
**Objective:** Ensure no secrets are present in tracked files and that a safe configuration template exists.

## Pre-requisites
- Access to the repository root.
- `rg` (ripgrep) or equivalent search tool.

## Verification Steps

### 1. Robust Secrets Scan (Must yield NO results)
Run the following commands to check for lingering secrets in tracked files.

**IMPORTANT:** The specific leaked passwords (starting with `Denta...` and `HX...`) should **NOT** appear in the output. You should verify this by searching for them, but **do not commit** those searches to this file.

```bash
# 1. Generic keyword scan (Expect only placeholders in .env.example or docs)
rg -n "password|secret|token|apikey|api_key|smtp|jwt|encryption" .

# 2. Check for default admin email usage in code (should be gone)
# (Replace [ADMIN_EMAIL_PLACEHOLDER] with the known default email)
rg "[ADMIN_EMAIL_PLACEHOLDER]" app/

# 3. Check for specific previous default passwords in code/scripts
# (Replace [LEAKED_PASSWORD_1] and [LEAKED_PASSWORD_2] with the known values from the audit report during runtime check)
# rg "[LEAKED_PASSWORD_1]" .
# rg "[LEAKED_PASSWORD_2]" .
```

*Expected Result:* You should see matches in `docs/` (audit logs, where they are redacted) and `.env.example` (placeholders). You should **NOT** see actual credentials in `app/`, `public/`, or `scripts/`.

### 2. Runtime Artifact Check
Verify that no runtime session or debug files containing secrets are tracked.

**PowerShell:**
```powershell
Get-ChildItem writable/session/* -Exclude index.html
Get-ChildItem writable/debugbar/* -Exclude index.html
```
*Expected Result:* No files returned (empty directories).

### 3. File Existence Check
Verify that sensitive files are **NOT** present and safe templates **ARE** present.

**PowerShell:**
```powershell
# Should return True
Test-Path .env.example

# Should return False
Test-Path .env
Test-Path environment.env
Test-Path ENVIRONMENT
Test-Path democa_dental.sql
Test-Path writable/backups/*.sql
```

### 4. Config & Script Validation
Check that configuration relies on environment variables.

*   `app/Config/Database.php`: Uses `env()`.
*   `scripts/repair_db_final.php`: Uses `getenv()`, no hardcoded arrays.
*   `scripts/check_users_table.php`: Uses `getenv()`.

## ⚠️ Important Git History Caveat
**Security Notice:** Removing secrets from the current working tree does **NOT** remove them from Git history. If this repository was previously public or shared with untrusted parties, all credentials (database passwords, API keys, etc.) that were ever committed must be considered **COMPROMISED**.

**Required Actions for Production:**
1.  **Rotate all secrets** immediately (change DB passwords, generate new encryption keys).
2.  Use tools like `git-filter-repo` or BFG Repo-Cleaner to permanently purge sensitive data from history if you intend to keep using this repo history.
3.  Treat the current repo state as a "clean slate" only for *future* commits.
