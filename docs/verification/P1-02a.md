# Verification: P1-02a API Response Shape (Code-Level)

**Task:** API Authentication & Authorization Fail-Closed Behavior
**Status:** VERIFIED (Code Inspection)
**Date:** 2026-01-07

## 1. AuthFilter Verification (Authentication)

### 1.1 API Detection & JSON 401
**File:** `app/Filters/AuthFilter.php`
**Lines:** 38-48

```php
38:             // Check if it's an API request
39:             $isApi = $request->hasHeader('Accept') && str_contains($request->getHeaderLine('Accept'), 'application/json');
40:             $uri = $request->getUri()->getPath();
41:             if (str_starts_with($uri, 'api/') || str_starts_with($uri, '/api/')) {
42:                 $isApi = true;
43:             }
44: 
45:             if ($isApi) {
46:                 $response = service('response');
47:                 return $response->setStatusCode(401)
48:                                 ->setJSON(['error' => 'unauthenticated']);
49:             }
```

**Reasoning:**
- **API Detection:** The code explicitly checks for `application/json` in the `Accept` header (Line 39) OR path starting with `api/` (Lines 40-42). This covers the requirement "Treat request as API if request path begins with '/api' OR the Accept header contains 'application/json'".
- **JSON Response:** If `$isApi` is true, it returns a 401 status code with a minimal JSON body `{'error': 'unauthenticated'}` (Lines 47-48). This satisfies "API requests return JSON 401... No redirects or HTML".

### 1.2 Non-API Redirect Preserved
**File:** `app/Filters/AuthFilter.php`
**Lines:** 51-54

```php
51:             // Store the current URL to redirect back after login
52:             session()->set('redirect_url', current_url());
53:             
54:             // Redirect to login page
55:             return redirect()->to('/auth/login');
```

**Reasoning:**
- If the request is NOT an API request (execution falls through Line 49), the standard redirect behavior is preserved (Line 55). This satisfies "Non-API requests must keep existing redirect behavior".

---

## 2. PermissionFilter Verification (Authorization)

### 2.1 Unauthorized API Request (JSON 403)
**File:** `app/Filters/PermissionFilter.php`
**Lines:** 52-62

```php
52:                 // Check if it's an API request
53:                 $isApi = $request->hasHeader('Accept') && str_contains($request->getHeaderLine('Accept'), 'application/json');
54:                 $uri = $request->getUri()->getPath();
55:                 if (str_starts_with($uri, 'api/') || str_starts_with($uri, '/api/')) {
56:                     $isApi = true;
57:                 }
58: 
59:                 if ($isApi) {
60:                     $response = service('response');
61:                     return $response->setStatusCode(403)
62:                                     ->setJSON(['error' => 'unauthorized']);
63:                 }
```

**Reasoning:**
- **Consistency:** Uses the same API detection logic as `AuthFilter`.
- **JSON Response:** Returns 403 Forbidden with minimal JSON body `{'error': 'unauthorized'}` (Lines 61-62). This satisfies "Authenticated but unauthorized requests fail closed with 403 JSON".

### 2.2 Unauthorized Non-API Request (Redirect)
**File:** `app/Filters/PermissionFilter.php`
**Lines:** 65-66

```php
65:                 // Return 403 Forbidden - redirect to a safe route without permission filters
66:                 return redirect()->to('/')->with('error', 'You do not have permission to access this resource.');
```

**Reasoning:**
- Non-API requests continue to redirect to the dashboard with an error flash message (Line 66).

### 2.3 Exception Fail-Closed (JSON 403)
**File:** `app/Filters/PermissionFilter.php`
**Lines:** 71-82

```php
71:             // Fail Closed
72:             $isApi = $request->hasHeader('Accept') && str_contains($request->getHeaderLine('Accept'), 'application/json');
73:             $uri = $request->getUri()->getPath();
74:             if (str_starts_with($uri, 'api/') || str_starts_with($uri, '/api/')) {
75:                 $isApi = true;
76:             }
77: 
78:             if ($isApi) {
79:                 $response = service('response');
80:                 return $response->setStatusCode(403)
81:                                 ->setJSON(['error' => 'unauthorized']);
82:             }
```

**Reasoning:**
- **Fail-Closed:** In the `catch` block (Line 67), the code NO LONGER allows access. It repeats the API check (Lines 72-76) and returns a 403 JSON response for API requests (Lines 80-81). This satisfies "Permission exceptions fail closed (403) with no stack trace leakage". The error message is generic "unauthorized", suppressing internal details.

### 2.4 Exception Non-API Request (Redirect)
**File:** `app/Filters/PermissionFilter.php`
**Line:** 84

```php
84:             return redirect()->to('/')->with('error', 'System error during permission check.');
```

**Reasoning:**
- For non-API requests, exceptions redirect to the dashboard with a generic error message (Line 84), preventing stack trace leakage to the user.