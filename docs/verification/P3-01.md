# Verification: P3-01 Notifications UI Remediation

This document verifies the removal of unsafe `innerHTML` sinks from the global notifications system in `app/Views/layouts/main_auth.php` and records the behavior contracts that must remain stable.

## 1. Remediated Sinks (app/Views/layouts/main_auth.php)

### displayNotifications()
- **Original sink:** Used `listElement.innerHTML` to render:
  - Empty state markup
  - The list of notifications via HTML templating (interpolating `title`, `message`, etc.)
- **Data source:** AJAX response from `<?= base_url('api/notifications') ?>` (DB-derived values).
- **Safe replacement:** Refactored to DOM construction using `document.createElement`, `textContent`, `document.createDocumentFragment()`, and `appendChild`.
- **Status:** REMEDIATED

## 2. Behavior Preservation Notes (Concrete Contracts)

Do not modify these selectors or logic patterns without a dedicated task, because they are relied upon by the notifications UI behavior.

### List container
- **Selector/lookup:** `document.getElementById('notifications-list')`
  - Reference: `app/Views/layouts/main_auth.php:737`

### Click navigation
- **Trigger:** Each notification item binds `onclick` to call:
  `navigateToEntityFromNotification(notification.entity_type || 'system', notification.entity_id || 'null')`
  - Reference: `app/Views/layouts/main_auth.php:764`

### Empty state
- **Condition:** `notifications.length === 0`
  - Reference: `app/Views/layouts/main_auth.php:742`
- **User-facing message:** `No new notifications` (rendered via `textContent`)
  - Reference: `app/Views/layouts/main_auth.php:750`

### Unread indicator (dot)
- **Condition:** `!notification.is_read`
- **Implementation:** a dot element with Tailwind classes `w-2 h-2 bg-blue-500 rounded-full` is appended
  - Reference: `app/Views/layouts/main_auth.php` (unread dot construction in `displayNotifications`)

## 3. Unread Count Update Contract

- **Badge element:** `#notification-count` (span).
  - Reference: `app/Views/layouts/main_auth.php:341`

- **Update mechanism:** `updateNotificationCount(count)` updates the badge via:
  - `document.getElementById('notification-count')`
  - Reference: `app/Views/layouts/main_auth.php:689-720`
    - Lookup: line 690
    - Update / visibility logic: lines 714–720

- **Behavior contract:**
  - When `count > 0`: sets `textContent = count` and removes `hidden`.
  - When `count === 0`: adds `hidden`.

## 4. Polling / Timing Preservation Evidence

- **Notifications refresh interval:** Notifications refresh loop runs every **30000 ms (30 seconds)** via:
  - `setInterval(() => { loadNotifications(); loadNotificationCount(); }, 30000);`
  - Reference: `app/Views/layouts/main_auth.php:1085`

- **Note on setTimeout:** A `setTimeout(..., 1000)` exists in this file, but it is used for **delaying patient-page global search** to allow DataTables initialization (not related to notifications polling).
  - Reference: `app/Views/layouts/main_auth.php:1106`

## 5. Evidence

- **Command:**  
  `rg -n "innerHTML|\.html\(|insertAdjacentHTML|outerHTML" app/Views/layouts/main_auth.php`
- **Output:** *(empty)* — no remaining matches.

## 6. Summary of Risk Reduction

- **XSS prevention:** All notification content (titles, messages, user names) is rendered via `textContent` and cannot execute as HTML/JS.
- **Behavior preserved:** UI structure, navigation, unread count, empty state, and polling behavior are preserved; only unsafe HTML templating was removed.
