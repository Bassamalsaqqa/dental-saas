# Verification P4-02b: Secure Logo Upload Pipeline

## File List Touched
- `app/Controllers/Settings.php`
- `app/Views/settings/index.php`
- `docs/verification/P4-02b.md`
- `docs/SECURITY_HARDENING_PROGRAM.md`
- `docs/IMPLEMENTATION_LOG.md`
- `docs/DECISION_LOG.md`
- `docs/USER_GUIDE_BRANDING.md`

## Validation Rules
- `max_size`: 512 KB
- `is_image`: must be a valid image
- `mime_in`: image/png, image/jpg, image/jpeg, image/webp
- `ext_in`: png, jpg, jpeg, webp
- **NO SVG SUPPORT** (to prevent XSS via SVG)

## Storage Logic
- **Destination**: `public/uploads/clinic/` (via `FCPATH`)
- **Filename**: `clinic-logo.<ext>` (deterministic, using `guessExtension()`)
- **Overwrite Policy**: Deletes any existing `clinic-logo.*` before moving the new file.
- **Database Path**: Stores relative path `uploads/clinic/clinic-logo.<ext>`.

## Verification Commands & Outputs

### 1. Branding Keys Search
Command: `rg -n "clinic_logo_path|clinic_logo" app`
Output:
(to be filled)

### 2. Upload Paths Search
Command: `rg -n "uploads/clinic|clinic-logo" app/Controllers/Settings.php app/Views/settings/index.php`
Output:
(to be filled)

### 3. DOM Sink Search
Command: `rg -n "innerHTML|outerHTML|insertAdjacentHTML|\.html\(" app/Views`
Output:
(to be filled)

## CORRECTION APPEND — Verbatim Evidence

### 1. Branding Keys Search (Post-Fix)
Command: rg -n "clinic_logo_path|clinic_logo" app
Output:
app\Views\settings\index.php:150:                                        <input type="file" name="clinic_logo" accept=".png,.jpg,.jpeg,.webp" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200">
app\Views\settings\index.php:155:                                        <input type="text" name="clinic_logo_path" value="<?= esc($settings['clinic_logo_path'] ?? '') ?>" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200" placeholder="e.g., assets/images/logo.png or https://example.com/logo.png">
app\Services\SettingsService.php:364:            'logo_path' => $this->get('clinic_logo_path', ''),
app\Controllers\Settings.php:46:            'clinic_logo_path' => 'permit_empty|max_length[255]',
app\Controllers\Settings.php:48:            'clinic_logo' => 'permit_empty|is_image[clinic_logo]|mime_in[clinic_logo,image/png,image/jpg,image/jpeg,image/webp]|max_size[clinic_logo,512]|ext_in[clinic_logo,png,jpg,jpeg,webp]',
app\Controllers\Settings.php:65:        $logoFile = $this->request->getFile('clinic_logo');
app\Controllers\Settings.php:86:                $settingsData['clinic_logo_path'] = 'uploads/clinic/' . $newName;

### 2. Upload Paths Search (Post-Fix)
Command: rg -n "uploads/clinic|clinic-logo" app/Controllers/Settings.php app/Views/settings/index.php
Output:
app/Controllers/Settings.php:67:            $uploadPath = FCPATH . 'uploads/clinic';
app/Controllers/Settings.php:74:            // Delete existing clinic-logo.*
app/Controllers/Settings.php:75:            $existingLogos = glob($uploadPath . '/clinic-logo.*');
app/Controllers/Settings.php:84:                $newName = 'clinic-logo.' . $ext;
app/Controllers/Settings.php:86:                $settingsData['clinic_logo_path'] = 'uploads/clinic/' . $newName;

### 3. DOM Sink Search (Post-Fix)
Command: rg -n "innerHTML|outerHTML|insertAdjacentHTML|\.html\(" app/Views
Output:
(empty)

